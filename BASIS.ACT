*:******************************************************************************
*:
*: Procedure File D:\DEVELOP\WORK\BASIS\STARTUP.PRG
*:
*:	ГлуховВ.ВовкО.БоярскихВ.АлдушинД.
*:	Система. Бизнес. Автоматизация.
*:	
*:	Екатеринбург
*:	
*:	620100
*:	Россия
*:	
*:	
*:	
*:	
*:	
*:	
*:
*: Documented using Visual FoxPro Formatting wizard version  .05
*:******************************************************************************
*:   STARTUP
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: BASIS.PRG
        * Module/Procedure: BASIS()
        * Called by.......: <NA>
        * Parameters......: <none>
        * Returns.........: <none>
        * Notes...........: Главная программа
        *-------------------------------------------------------
        Lparameters luParamString
        
        *01.05.2004 20:00 ->Для определения запускаемого приложения используем константы
        #Define cnAPPLICATION_NAME	BASIS
        *------------------------------------------------------------------------------
        *SYS(2800 ,3 )
        
        *01.05.2004 19:51 ->Объявление и инициализация переменных
        Local	lcExecuteProgram, ;
                lcExecuteProgramExtension, ;
                lcExecuteProgramPath, ;
                lcApplicationNM, ;
                lcApplicationClassLib, ;
                lcApplicationIniFNM, ;
                llDebugModeFlg, ;
                llLibLoad
        ***
        lcExecuteProgram = Sys(16)
        lcExecuteProgramExtension = Upper(Right(lcExecuteProgram,3))
        lcExecuteProgramPath = Upper(Substr(lcExecuteProgram,1,Rat([\],lcExecuteProgram)))
        ***
        lcApplicationNM = [cnAPPLICATION_NAME]
        lcApplicationClassLib = lcApplicationNM + [.VCX]
        lcApplicationIniFNM = lcExecuteProgramPath + lcApplicationNM + [.INI]
        *------------------------------------------------------------------------------
        
        *14.08.2006 11:18 ->Распахнем окно на весь экран
        _Screen.WindowState = 2
        *------------------------------------------------------------------------------
        *PUBLIC llDebugModeFlg
        *02.05.2004 15:00 ->Проверим режим запуска
ЪДДДДДДДIf Inlist(lcExecuteProgramExtension,[EXE],[APP],[DLL])
і               llDebugModeFlg = .F.
ГДДДДДДДElse
і               llDebugModeFlg = .T.
АДДДДДДДEndif
        *------------------------------------------------------------------------------
        
        *02.05.2004 15:47 ->Перейдем в каталог приложения и установим необходимые пути
ЪДДДДДДДIf lcExecuteProgramPath # Fullpath(Curdir())
і               Cd (lcExecuteProgramPath)
АДДДДДДДEndif
        ***
ЪДДДДДДДIf !llDebugModeFlg
і               Set Path To [Tmp;ImgBmp;ImgIco;Resource;Data;Drivers]
ГДДДДДДДElse
і               Set Path To [Tmp;ImgBmp;ImgIco;Resource;Graphic;Library;Menu;Program;Data;Drivers]
і               Close Databases All
АДДДДДДДEndif
        *------------------------------------------------------------------------------
        
        *02.05.2004 15:47 ->Создадим объект для работы с окружением
ЪДДДДДДДIf !([GENERAL_V1.VCX]$Set([CLASSLIB]))
і               Set Classlib To GENERAL_V1.vcx Alias GENERAL_V1 Additive
і               llLibLoad = .T.
ГДДДДДДДElse
і               llLibLoad = .F.
АДДДДДДДEndif
        oEnv = Createobject([environment],llDebugModeFlg)
ЪДДДДДДДIf llLibLoad
і               Release Classlib Alias GENERAL_V1
АДДДДДДДEndif
        *------------------------------------------------------------------------------
        
        *02.05.2004 15:48 ->Создадим объект для работы с INI файлами
ЪДДДДДДДIf !([GENERAL_V1.VCX]$Set([CLASSLIB]))
і               Set Classlib To GENERAL_V1.vcx Alias GENERAL_V1 Additive
і               llLibLoad = .T.
ГДДДДДДДElse
і               llLibLoad = .F.
АДДДДДДДEndif
        oRes = Createobject([resource],lcApplicationIniFNM)
ЪДДДДДДДIf llLibLoad
і               Release Classlib Alias GENERAL_V1
АДДДДДДДEndif
        *------------------------------------------------------------------------------
        
        *02.05.2004 15:48 ->Создадим объект для работы с параметрами выборок
ЪДДДДДДДIf !([QUERYPARAMIO_V1.VCX]$Set([CLASSLIB]))
і               Set Classlib To QUERYPARAMIO_V1.vcx Alias QUERYPARAMIO_V1 Additive
і               llLibLoad = .T.
ГДДДДДДДElse
і               llLibLoad = .F.
АДДДДДДДEndif
        oQryParMgr = Createobject([QueryParamMgr])
ЪДДДДДДДIf llLibLoad
і               Release Classlib Alias QUERYPARAMIO_V1
АДДДДДДДEndif
        *------------------------------------------------------------------------------
        
        *14.09.2005 10:08 -> Создадим объект для работы со штрих-кодами
ЪДДДДДДДIf !([TOVARLOOKUP_V1.VCX]$Set([CLASSLIB]))
і               Set Classlib To TOVARLOOKUP_V1.vcx Alias TOVARLOOKUP_V1 Additive
і               llLibLoad = .T.
ГДДДДДДДElse
і               llLibLoad = .F.
АДДДДДДДEndif
        oTLU = Createobject([TovarLookUp])
ЪДДДДДДДIf llLibLoad
і               Release Classlib Alias TOVARLOOKUP_V1
АДДДДДДДEndif
        *------------------------------------------------------------------------------
        
        *02.05.2004 15:52 ->Создаем объект приложения
ЪДДДДДДДIf !(lcApplicationClassLib$Set([CLASSLIB]))
і               Set Classlib To (lcApplicationClassLib) Alias (lcApplicationNM) Additive
і               llLibLoad = .T.
ГДДДДДДДElse
і               llLibLoad = .F.
АДДДДДДДEndif
        oApp = Createobject(lcApplicationNM,llDebugModeFlg)
ЪДДДДДДДIf llLibLoad
і               Release Classlib Alias (lcApplicationNM)
АДДДДДДДEndif
        *------------------------------------------------------------------------------
        
        *19.01.2005 15:39 -> Создаем объекты менеджеры
ЪДДДДДДДIf Type([oApp]) == [O]
і               oMgrClient   = oApp.Createobject([interface;client_v1;client.app])
і               oMgrTovar    = oApp.Createobject([interface;tovar_v1;tovar.app])
і               oMgrPD 	     = oApp.Createobject([interface;primarydoc_v1;primarydoc.app])
і               oMgrRpt      = oApp.Createobject([interface;report_v1;report.app])
і               oMgrFormType = oApp.Createobject([interface;formtype_v1;formtype.app])
і               oMgrOrgUnit  = oApp.Createobject([interface;orgunit_v1;orgunit.app])
і               oMgrQryPar   = oApp.Createobject([interface;queryparam_v1;queryparam.app])
і               oMgrScrFrm   = oApp.Createobject([interface;screenform_v1;screenform.app])
і               oMgrDevice	 = oApp.Createobject([interface;device_v1;device.app])
і               oMgrCash	 = oApp.Createobject([interface;cash_v1;cash.app])
і               oMgrDisc	 = oApp.Createobject([interface;discount_v1;discount.app])
і               oMgrUser	 = oApp.Createobject([interface;user_v1;user.app])
і               oMgrPOS		 = oApp.Createobject([interface;poscfg_v1;poscfg.app])
і               oMgrCoupon	 = oApp.Createobject([interface;coupon_v1;coupon.app])
і               oMgrPBook	 = oApp.Createobject([interface;pbook_v1;pbook.app])
і               oMgrAdmin	 = oApp.Createobject([interface;admin;admin.app])
і               oMgrCard	 = oApp.Createobject([interface;card_v1;card.app])
і               oSession	 = Newobject([WorkSession],[Messenger.prg])
АДДДДДДДEndif
        *------------------------------------------------------------------------------
        
        *02.05.2004 16:02 ->Запускаем приложение
ЪДДДДДДДIf Type([oApp]) == [O]
і               oApp.STARTUP()
АДДДДДДДEndif
        *------------------------------------------------------------------------------
        
        *******************************************************************************
        *После того, как приложение отработало удаляем объекты в нужной нам последовательности
        *******************************************************************************
        Release oSession
        Release oMgrAdmin
        Release oMgrPBook
        Release oMgrClient
        Release oMgrTovar
        Release oMgrPD
        Release oMgrRpt
        Release oMgrFormType
        Release oMgrOrgUnit
        Release oMgrQryPar
        Release oMgrScrFrm
        Release oMgrDevice
        Release oMgrCash
        Release oMgrDisc
        Release oMgrUser
        Release oMgrPOS
        Release oMgrCoupon
        Release oApp
        Release oTLU
        Release oQryParMgr
        Release oRes
        Release oEnv
        *------------------------------------------------------------------------------
        Sys(2800 ,0 )
        
        *02.05.2004 16:03 ->Очистим память занимаемую всеми другими объектами
        Clear All
        *------------------------------------------------------------------------------
        
        ************************************************************************************
        **********************************  END PROCEDURE **********************************
        ************************************************************************************
*:******************************************************************************
*:
*: Procedure File D:\БАЗЫ КЛИЕНТОВ\БАЗЫ УРАЛЬСКОЙ ФАКТОРИИ\UNION PROV_ALL.PRG
*:
*:	ГлуховВ.ВовкО.БоярскихВ.АлдушинД.
*:	Система. Бизнес. Автоматизация.
*:	
*:	Екатеринбург
*:	
*:	620100
*:	Россия
*:	
*:	
*:	
*:	
*:	
*:	
*:
*: Documented using Visual FoxPro Formatting wizard version  .05
*:******************************************************************************
*:   UNION PROV_ALL
        Set Path To Data;Forms;LIBS;Menu;PROGS;REPORTS;QUERIES;;
                LABELS;Other;Tmp;\\Server\Base\INTELL.VID\BASIS\Data;;
                "d:\базы уральской фактории"
        
        
        
        
        
        
        
        
        
        **************************
        **************************
        **************************
        **** Замена в форм типа
        
        
        ***TOP 10
        
        
        
        
        
        
        Insert Into BASIS!Form (FrmTypeId, FrmDate, FrmDateAcc, FrmReason, FrmNote, ;
                FrmNum, PointEmiCltID, PointIspCltID, ContrCltID, ID_,  ;
                FrmStatusID, FrmIsPayed, FrmAttribute ) ;
                SELECT 35, Dat_pr, Dat_pr, Alltrim(Text), Alltrim(id_docum), ;
                ALLTRIM(Str(Summa,16,2)), Client.cltid, Client.cltid, Client.cltid, Kkey,  ;
                2, .T., 0 From bu_all ;
                INNER Join BASIS!Client On  bu_all.kod_k = Client.ID_ ;
                ORDER By Dat_pr
        
        Requery('form')
        
        Insert Into BASIS!PracticalBook (PBookFrmId, PBookSum, DebetID, CreditID, PBookNote) ;
                SELECT Form.frmid, prov_all_deno.Summ, prov_all_deno.DebetID, prov_all_deno.CreditID,;
                prov_all_deno.Note ;
                FROM BASIS!Form ;
                LEFT Outer Join prov_all_deno On  Form.ID_ = prov_all_deno.Kkey ;
                WHERE Form.FrmTypeId = 35 And Form.ID_<>0
        
        #Define	pcvCONNECTIONNAME	[SQLBASISCONNECTION]
        #Define	pcvLOCKTIMEOUT		[10000]
        #Define	pcvERRORHEADMSG		"[Microsoft][ODBC SQL Server Driver][SQL Server]"
        
        *02.08.2005 16:58 ->Константы для маркированнных списков (наборов)
        #Define	NOT_CHILD_MARKED		0
        #Define	ALL_CHILD_MARKED		1
        #Define	PART_CHILD_MARKED		2
        *------------------------------------------------------------------------------
        
        *12.07.2005 14:39 ->Константы - заполнители полей
        #Define	__INTEGER	00000000000
        #Define __FLOAT		00000000000.000
        *------------------------------------------------------------------------------
        
        *-------------------------------------------------------
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: dbc_AfterOpenTable()
        * Called by.......: <DBC Event>
        * Parameters......: <tcTableName>
        * Returns.........: <none>
        * Notes...........:
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure dbc_AfterOpenTable(tcTableName)
і               
і               *31.03.2006 16:50 ->Объявление и инициализация переменных
і               Local	lnConnHandler, ;
і                       lnSqlExeResult, lcTbl4
і               lcTbl4 = Upper(Substr(Alltrim(tcTableName),1,4))
і       ЪДДДДДДДIf lcTbl4 = 'EDEL' Or lcTbl4 = 'BOLI'
і       і               Return
і       АДДДДДДДEndif
і               lnConnHandler = -1
і               *------------------------------------------------------------------------------
і               **WAIT WINDOW 1
і               *31.03.2006 16:51 -> Получим номер Connection
і       ЪДДДДДДДIf CursorGetProp([SourceType],tcTableName) = 2 && Remote View
і       і               lnConnHandler = CursorGetProp([ConnectHandle],tcTableName)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *31.03.2006 16:52 -> Создадим временную таблицу для хранения ID
і       ЪДДДДДДДIf lnConnHandler > 0
і       і               lnSqlExeResult = 0
і       і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і       і               lnSqlExeResult = SQLExec(lnConnHandler, ;
і       і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і       і                       [IF OBJECT_ID('tempdb..#LastIncrID') IS NULL CREATE TABLE #LastIncrID (TableNM varchar(40), LastID INT)])
і       і       АДДДДДДДEnddo
і       і               ***
і       і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і       і               spHandleODBCError()
і       і       і               Return
і       і       АДДДДДДДEndif
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: GetServerDate()
        * Called by.......: <>
        * Parameters......: <none>
        * Returns.........: <none>
        * Notes...........: <Получение даты с сервера>
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure GetServerDate
і               *31.03.2006 16:50 ->Объявление и инициализация переменных
і               Local	lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       ltServerDate As Datetime
і               *------------------------------------------------------------------------------
і               
і               *28.03.2007 12:10 ->Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *28.03.2007 12:10 ->Получаем дату с сервера
і       ЪДДДДДДДIf lnConnectHandle > 0
і       і               lnSqlExeResult = 0
і       і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і       і                       [SELECT GETDATE() AS GetDate],[curGetDate])
і       і       АДДДДДДДEnddo
і       і               ***
і       і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і       і               spHandleODBCError()
і       і       і               SQLDisconnect(lnConnectHandle)
і       і       і               Return Ctot([])
і       і       АДДДДДДДEndif
і       і               
і       і               ltServerDate = curGetDate.GetDate
і       і               Use In Select([curGetDate])
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *28.03.2007 12:13 ->Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               Return ltServerDate
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: LockEnter()
        * Called by.......: <>
        * Parameters......: <none>
        * Returns.........: <none>
        * Notes...........: <Проверка возможности запуска программы>
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure LockEnter
і               
і               *02.04.2007 09:42 ->Объявление и инициализация переменных
і               Local	lnConnectHandle As Integer, ;
і                       lnSqlExeResult	As Integer, ;
і                       llResult		As Boolean
і               *------------------------------------------------------------------------------
і               
і               *02.04.2007 09:42 ->Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *28.03.2007 12:10 ->Проверяем возможность запуска программы
і       ЪДДДДДДДIf lnConnectHandle > 0	And lnSqlExeResult = 0
і       і               
і       і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і       і                       [SELECT COUNT(*) FROM EventJrn WHERE EventJrn.EventJrnCode = 1],[curEventJrn])
і       і       АДДДДДДДEnddo
і       і               ***
і       і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і       і               SQLDisconnect(lnConnectHandle)
і       і       і               Return .F.
і       і       АДДДДДДДEndif
і       і               
і       і               llResult = (Reccount([curEventJrn]) = 0)
і       і               Use In Select([curEventJrn])
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *28.03.2007 12:13 ->Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               Return llResult
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spAccChangePrc()
        * Called by.......: <NA>
        * Parameters......: <tnTvrID, tnNewPrcBuy>
        * Returns.........: <none>
        * Notes...........: Изменение цены во всех калькуляциях
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spAccChangePrc
і               Lparameters tnTvrID, tnNewPrcBuy
і               
і               *24.08.2005 14:15 -> Объявление и инициализация переменных
і               Local	lnSqlExeResult, ;
і                       llResult
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Меняем цену во всех калькуляциях
і               lnSqlExeResult = 0
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [UPDATE ] + ;
і       і                       [FrmPartTvr ] + ;
і       і                       [SET TvrPrcBuy = ?tnNewPrcBuy ] + ;
і       і                       [WHERE FrmPartTvr.TvrID = ?tnTvrID AND FrmPartTvr.FrmID IN (SELECT Form.FrmID FROM Form WHERE Form.FrmTypeID = 19)])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return 0
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spAccountingView()
        * Called by.......: <Form Data Request>
        * Parameters......: <tcExecVar[,tuParam1,tuParam2]>
        *					<[NODATA]>
        *					<[BYFRMID],tnScrFrmID,tnFrmID>
        *					<[BYFILTER],tnScrFrmID,tcQryParSID>
        * Returns.........: <lcUniqueFileName>
        * Notes...........: Получение данных для просмотра калькуляционных карт
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spAccountingView
і               Lparameters tcExecVar,tuParam1,tuParam2
і               
і               *21.04.2004 12:31 -> Объявление и инициализация переменных
і               Local	lcOldDate, ;
і                       lcOldCentury, ;
і                       lcOldMark, ;
і                       lcUniqueName, ;
і                       lcUniqueFilePath, ;
і                       lcFilterExpr, ;
і                       lcValueList, ;
і                       luQryParDateEnabled, ;
і                       luQryParDateStartDate, ;
і                       luQryParDateEndDate, ;
і                       luQryParCltEnabled, ;
і                       luQryParCltIDTableNM, ;
і                       luQryParOUEnabled, ;
і                       luQryParOUIDTableNM, ;
і                       luQryParFrmTypeEnabled, ;
і                       luQryParFrmTypeIDTableNM, ;
і                       luQryParFrmStatEnabled, ;
і                       luQryParFrmStatIDTableNM, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldDate = Set([DATE])
і               lcOldCentury = Set([CENTURY])
і               lcOldMark = Set([MARK])
і               lcUniqueName = [_d] + Sys(2015)
і               lcUniqueFilePath = [tmp\] + lcUniqueName + [.DBF]
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 12:33 -> Формируем фильтры в зависимости от типа запроса
і       ЪДДДДДДДDo Case
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[NODATA]
і       і               
і       і               *21.04.2004 12:34 -> Формируем фильтр, для формирования пустой выборки
і       і               lcFilterExpr = [WHERE 0=1]
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[11QUEUE]
і       і               
і       і               *21.04.2004 12:34 -> Формируем фильтр, для формирования пустой выборки
і       і               lcFilterExpr = [WHERE Form.FrmID IN (SELECT Frmpayqueue.frmid FROM frmpayqueue)]
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[BYFRMID]
і       і               
і       і               *21.04.2004 12:32 -> Формируем фильтр для выбора одного документа
і       і               lcFilterExpr = [WHERE 0<>1] + ;
і       і                       [ AND ScrFrmViewObj.ScrFrmID = ] + Alltrim(Str(tuParam1)) + ;
і       і                       [ AND Form.FrmID = ]+Alltrim(Str(tuParam2))
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And (tcExecVar==[BYFILTER] Or tcExecVar==[QUEUE])
і       і               
і       і               *********************************************************************************
і       і               *Формируем выражения для отбора документов, соответствующих всем фильтрам		*
і       і               *********************************************************************************
і       і               
і       і               *26.05.2004 21:08 -> Основное условие, для отбора документов по ЭФ
і       і       ЪДДДДДДДIf tcExecVar==[QUEUE]
і       і       і               lcFilterExpr = [WHERE Form.FrmID IN (SELECT Frmpayqueue.frmid FROM frmpayqueue) ] + ;
і       і       і                       [ AND ScrFrmViewObj.ScrFrmID = ] + Alltrim(Str(tuParam1))
і       і       ГДДДДДДДElse
і       і       і               lcFilterExpr = [WHERE 0<>1] + ;
і       і       і                       [ AND ScrFrmViewObj.ScrFrmID = ] + Alltrim(Str(tuParam1))
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *26.05.2004 21:20 -> Дальнейшие параметры обрабатываем, если существует менеджер параметров
і       і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і       і               
і       і       і               *26.05.2004 21:18 -> Формируем фильтр по дате
і       і       і               luQryParDateEnabled = oQryParMgr.ParamGet(tuParam2,[qplDateEnabled])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParDateEnabled) And Type([luQryParDateEnabled])==[L] And luQryParDateEnabled
і       і       і       і               
і       і       і       і               *26.05.2004 21:33 -> Получим дату стартовую и конечную
і       і       і       і               luQryParDateStartDate = oQryParMgr.ParamGet(tuParam2,[qpdDateStart])
і       і       і       і               luQryParDateEndDate = oQryParMgr.ParamGet(tuParam2,[qpdDateEnd])
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       і               *21.04.2006 10:33 -> Установим формат даты YMD и CENTURY ON
і       і       і       і               Set Date YMD
і       і       і       і               ***
і       і       і       і               Set Century On
і       і       і       і               ***
і       і       і       і               Set Mark To "/"
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       і               *26.05.2004 21:27 -> Формируем условие
і       і       і       і       ЪДДДДДДДDo Case
і       і       і       і       ГДДДДДДДCase	!Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate) And ;
і       і       і       і       і                       !Isnull(luQryParDateEndDate) And Type([luQryParDateEndDate])==[D] And !Empty(luQryParDateEndDate)
і       і       і       і       і               *{
і       і       і       і       і               lcFilterExpr = lcFilterExpr + [ AND Form.FrmDate >= ']+Strtran(Dtoc(luQryParDateStartDate),[/],[])+[' AND Form.FrmDate < ']+Strtran(Dtoc(luQryParDateEndDate+1),[/],[])+[']
і       і       і       і       і               *}
і       і       і       і       ГДДДДДДДCase	!Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate)
і       і       і       і       і               *{
і       і       і       і       і               lcFilterExpr = lcFilterExpr + [ AND Form.FrmDate >= ']+Strtran(Dtoc(luQryParDateStartDate),[/],[])+[']
і       і       і       і       і               *}
і       і       і       і       ГДДДДДДДCase	!Isnull(luQryParDateEndDate) And Type([luQryParDateEndDate])==[D] And !Empty(luQryParDateEndDate)
і       і       і       і       і               *{
і       і       і       і       і               lcFilterExpr = lcFilterExpr + [ AND Form.FrmDate < ']+Strtran(Dtoc(luQryParDateEndDate+1),[/],[])+[']
і       і       і       і       і               *}
і       і       і       і       АДДДДДДДEndcase
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       і               *21.04.2006 10:33 -> Восстановим старый формат даты
і       і       і       і               Set Date (lcOldDate)
і       і       і       і               ***
і       і       і       і               Set Century &lcOldCentury
і       і       і       і               ***
і       і       і       і               Set Mark To lcOldMark
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *27.05.2004 00:29 -> Формируем фильтр (Выбор клиента (EMI))
і       і       і               luQryParCltEnabled = oQryParMgr.ParamGet(tuParam2,[qplCltEmiEnabled])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParCltEnabled) And Type([luQryParCltEnabled])==[L] And luQryParCltEnabled
і       і       і       і               
і       і       і       і               *27.05.2004 00:32 -> Получим имя временной таблицы с идентификаторами клиентов
і       і       і       і               luQryParCltIDTableNM = oQryParMgr.ParamGet(tuParam2,[qpcCltEmiIDTableNM])
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf !Isnull(luQryParCltIDTableNM) And Type([luQryParCltIDTableNM])==[C] And File([tmp\]+luQryParCltIDTableNM+[.dbf])
і       і       і       і       і               
і       і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і       і                       [ AND Form.PointEmiCltID IN (] + spGetTmpValueList(luQryParCltIDTableNM) + [)]
і       і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і       і               
і       і       і       і       АДДДДДДДEndif
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *23.04.2006 00:29 ->Формируем фильтр (Выбор товаров)
і       і       і               luQryParTvrEnabled = oQryParMgr.ParamGet(tuParam2,[qplTvrEnabled])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParTvrEnabled) And Type([luQryParTvrEnabled])==[L] And luQryParTvrEnabled
і       і       і       і               
і       і       і       і               *23.04.2006 00:32 ->Получим имя временной таблицы с идентификаторами товАРОВ
і       і       і       і               luQryParTvrIDTableNM = oQryParMgr.ParamGet(tuParam2,[qpcTvrIDTableNM])
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf !Isnull(luQryParTvrIDTableNM) And Type([luQryParTvrIDTableNM])==[C] And File([tmp\]+luQryParTvrIDTableNM+[.dbf])
і       і       і       і       і               
і       і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і       і                       [ AND FrmPartTvr.TvrId IN (] + spGetTmpValueList(luQryParTvrIDTableNM) + [)]
і       і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і       і               
і       і       і       і       АДДДДДДДEndif
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *27.05.2004 00:29 ->Формируем фильтр (Выбор клиента (ISP))
і       і       і               luQryParCltEnabled = oQryParMgr.ParamGet(tuParam2,[qplCltIspEnabled])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParCltEnabled) And Type([luQryParCltEnabled])==[L] And luQryParCltEnabled
і       і       і       і               
і       і       і       і               *27.05.2004 00:32 ->Получим имя временной таблицы с идентификаторами клиентов
і       і       і       і               luQryParCltIDTableNM = oQryParMgr.ParamGet(tuParam2,[qpcCltIspIDTableNM])
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf !Isnull(luQryParCltIDTableNM) And Type([luQryParCltIDTableNM])==[C] And File([tmp\]+luQryParCltIDTableNM+[.dbf])
і       і       і       і       і               
і       і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і       і                       [ AND Form.PointIspCltID IN (] + spGetTmpValueList(luQryParCltIDTableNM) + [)]
і       і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і       і               
і       і       і       і       АДДДДДДДEndif
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *27.05.2004 00:29 ->Формируем фильтр (Выбор клиента (EMI OR ISP))
і       і       і               luQryParCltEnabled = oQryParMgr.ParamGet(tuParam2,[qplCltEnabled])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParCltEnabled) And Type([luQryParCltEnabled])==[L] And luQryParCltEnabled
і       і       і       і               
і       і       і       і               *27.05.2004 00:32 ->Получим имя временной таблицы с идентификаторами клиентов
і       і       і       і               luQryParCltIDTableNM = oQryParMgr.ParamGet(tuParam2,[qpcCltIDTableNM])
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf !Isnull(luQryParCltIDTableNM) And Type([luQryParCltIDTableNM])==[C] And File([tmp\]+luQryParCltIDTableNM+[.dbf])
і       і       і       і       і               
і       і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і       і               lcValueList = spGetTmpValueList(luQryParCltIDTableNM)
і       і       і       і       і               ***
і       і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і       і                       [ AND (Form.PointEmiCltID IN (] + lcValueList + [)] + ;
і       і       і       і       і                       [ OR Form.PointIspCltID IN (] + lcValueList + [))]
і       і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і       і               
і       і       і       і       АДДДДДДДEndif
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *28.05.2004 03:01 ->Формируем фильтр (Выбор отдела (EMI))
і       і       і               luQryParOUEnabled = oQryParMgr.ParamGet(tuParam2,[qplOUEmiEnabled])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParOUEnabled) And Type([luQryParOUEnabled])==[L] And luQryParOUEnabled
і       і       і       і               
і       і       і       і               *28.05.2004 00:37 ->Получим имя таблицы с идентификаторами подразделений
і       і       і       і               luQryParOUIDTableNM = oQryParMgr.ParamGet(tuParam2,[qpcOUEmiIDTableNM])
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf !Isnull(luQryParOUIDTableNM) And Type([luQryParOUIDTableNM])==[C] And File([tmp\]+luQryParOUIDTableNM+[.dbf])
і       і       і       і       і               
і       і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і       і                       [ AND Form.PointEmiOUID IN (] + spGetTmpValueList(luQryParOUIDTableNM) + [)]
і       і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і       і               
і       і       і       і       АДДДДДДДEndif
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *28.05.2004 03:01 ->Формируем фильтр (Выбор отдела (ISP))
і       і       і               luQryParOUEnabled = oQryParMgr.ParamGet(tuParam2,[qplOUIspEnabled])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParOUEnabled) And Type([luQryParOUEnabled])==[L] And luQryParOUEnabled
і       і       і       і               
і       і       і       і               *28.05.2004 00:37 ->Получим имя таблицы с идентификаторами подразделений
і       і       і       і               luQryParOUIDTableNM = oQryParMgr.ParamGet(tuParam2,[qpcOUIspIDTableNM])
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf !Isnull(luQryParOUIDTableNM) And Type([luQryParOUIDTableNM])==[C] And File([tmp\]+luQryParOUIDTableNM+[.dbf])
і       і       і       і       і               
і       і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і       і                       [ AND Form.PointIspOUID IN (] + spGetTmpValueList(luQryParOUIDTableNM) + [)]
і       і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і       і               
і       і       і       і       АДДДДДДДEndif
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *28.05.2004 00:32 ->Формируем фильтр (Выбор отдела (EMI OR ISP))
і       і       і               luQryParOUEnabled = oQryParMgr.ParamGet(tuParam2,[qplOUEnabled])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParOUEnabled) And Type([luQryParOUEnabled])==[L] And luQryParOUEnabled
і       і       і       і               
і       і       і       і               *28.05.2004 00:37 ->Получим имя таблицы с идентификаторами подразделений
і       і       і       і               luQryParOUIDTableNM = oQryParMgr.ParamGet(tuParam2,[qpcOUIDTableNM])
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf !Isnull(luQryParOUIDTableNM) And Type([luQryParOUIDTableNM])==[C] And File([tmp\]+luQryParOUIDTableNM+[.dbf])
і       і       і       і       і               
і       і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і       і               lcValueList = spGetTmpValueList(luQryParOUIDTableNM)
і       і       і       і       і               ***
і       і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і       і                       [ AND (Form.PointEmiOUID IN (] + lcValueList + [)] + ;
і       і       і       і       і                       [ OR Form.PointIspOUID IN (] + lcValueList + [))]
і       і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і       і               
і       і       і       і       АДДДДДДДEndif
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *19.01.2005 17:07 -> Формируем фильтр (Выбор типа документа)
і       і       і               luQryParFrmTypeEnabled = oQryParMgr.ParamGet(tuParam2,[qplFrmTypeEnabled])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParFrmTypeEnabled) And Type([luQryParFrmTypeEnabled])==[L] And luQryParFrmTypeEnabled
і       і       і       і               
і       і       і       і               *19.01.2005 17:08 -> Получим имя таблицы с идентификаторами типов документов
і       і       і       і               luQryParFrmTypeIDTableNM = oQryParMgr.ParamGet(tuParam2,[qpcFrmTypeIDTableNM])
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf !Isnull(luQryParFrmTypeIDTableNM) And Type([luQryParFrmTypeIDTableNM])==[C] And File([tmp\]+luQryParFrmTypeIDTableNM+[.dbf])
і       і       і       і       і               
і       і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і       і                       [ AND Form.FrmTypeID IN (] + spGetTmpValueList(luQryParFrmTypeIDTableNM) + [)]
і       і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і       і               
і       і       і       і       АДДДДДДДEndif
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *22.02.2006 16:55 -> Формируем фильтр (Выбор статуса документа)
і       і       і               luQryParFrmStatEnabled = oQryParMgr.ParamGet(tuParam2,[qplFrmStatEnabled])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParFrmStatEnabled) And Type([luQryParFrmStatEnabled])==[L] And luQryParFrmStatEnabled
і       і       і       і               
і       і       і       і               *22.02.2006 16:55 -> Получим имя таблицы с идентификаторами статусов документов
і       і       і       і               luQryParFrmStatIDTableNM = oQryParMgr.ParamGet(tuParam2,[qpcFrmStatIDTableNM])
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf !Isnull(luQryParFrmStatIDTableNM) And Type([luQryParFrmStatIDTableNM])==[C] And File([tmp\]+luQryParFrmStatIDTableNM+[.dbf])
і       і       і       і       і               
і       і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і       і                       [ AND Form.FrmStatusID IN (] + spGetTmpValueList(luQryParFrmStatIDTableNM) + [)]
і       і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і       і               
і       і       і       і       АДДДДДДДEndif
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *10.01.2006 17:07 -> Формируем фильтр (Выбор типа документа)
і       і       і               luQryParFrmTypeEnabled = oQryParMgr.ParamGet(tuParam2,[qplQueue])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParFrmTypeEnabled) And Type([luQryParFrmTypeEnabled])==[L] And luQryParFrmTypeEnabled
і       і       і       і               
і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і                       [ AND Form.FrmID IN (SELECT Frmpayqueue.frmid FROM frmpayqueue)]
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndcase
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spAccountingView ?lcFilterExpr],lcUniqueName)
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *11.08.2006 15:26 ->Вызовем процедуру обработки ошибок
і       і               spHandleODBCError()
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.08.2006 15:19 ->Создадим пустой курсор для возврата
і       і               Create Cursor (lcUniqueName) ( ;
і       і                       _mark L, frmid I, FrmTypeId I, FrmDate T, FrmNum C(1), FrmNote C(1), StatusID I, FrmIsPayed L, ;
і       і                       FTShortNM C(1), PEmiNM C(1), PIspNM C(1), FrmSum I, FrmVatSum I, FrmSumSale I, FrmSumBuy I, ;
і       і                       FrmVatSale I, FrmVatBuy I, AccFrmID I, AccTvrId I, AccQnt I, AccExit C(1), AccIsActiv F, ;
і       і                       AccColor C(1), AccAppr C(1), AccTaste C(1), AccSmell C(1), AccState C(1), AccTech C(1), ;
і       і                       AccCaloric C(1), AccFiber C(1), AccFat C(1), AccCarb C(1), AccNote C(1), AccTCard C(1), ;
і       і                       AccNetto I, AccPrice I, TvrNm C(1), FrmSign I ;
і       і                       )
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсор в файл и закроем
і               Select (lcUniqueName)
і               ***
і               Copy To (lcUniqueFilePath)
і               ***
і               Use In Select(lcUniqueName)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 14:27 -> Вернем значение
і               Return lcUniqueName
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spAppendAccount()
        * Parameters......: <tnTvrId, tnTvrTypeID>
        * Returns.........: <NA>
        * Notes...........: Добавляет калькуляцию в базу данных
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spAppendAccount
і               Lparameters tnTvrID, tnTvrTypeID
і               
і               *01.06.2006 16:44 -> VG
і       ЪДДДДДДДIf tnTvrTypeID = 5 Or tnTvrTypeID = 6
і       і               
і       і               *31.05.2006 10:05 -> Объявление и инициализация переменных
і       і               Local   lnConnectHandle, ;
і       і                       lnSqlExeResult
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і       і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *07.04.2006 16:45 -> Выполняем запрос
і       і               lnSqlExeResult = 0
і       і               ***
і       і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і       і                       [EXECUTE spAppendAccount ?tnTvrId])
і       і       АДДДДДДДEnddo
і       і               ***
і       і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і       і               spHandleODBCError()
і       і       і               Return .F.
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і       і               SQLDisconnect(lnConnectHandle)
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spBindDisc()
        * Called by.......: <NA>
        * Parameters......: <tnCheckID,tnDiscCardID>
        * Returns.........: <none>
        * Notes...........:	Привязка дисконтной карты к чеку
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spBindDisc
і               Lparameters tnCheckID,tnDiscCardID
і               
і               *31.05.2006 10:05 -> Объявление и инициализация переменных
і               Local   lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Привязываем
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [UPDATE CheckSale ] + ;
і       і                       [SET DiscCardID = ?tnDiscCardID ] + ;
і       і                       [WHERE CheckID = ?tnCheckID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spBookBuyReport()
        * Called by.......: <When Document Printed>
        * Parameters......: <tcQryParSID>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати книги покупок
        *-------------------------------------------------------
ЪДДДДДДДProcedure spBookBuyReport
і               Lparameters tcQryParSID
і               
і               *21.04.2004 12:31 -> Объявление и инициализация переменных
і               Local	lcFilterExpr, ;
і                       lcJoinExpr, ;
і                       lcAliasListToClose, ;
і                       luQryParDateEnabled, ;
і                       luQryParDateStartDate, ;
і                       luQryParDateEndDate
і               ***
і               lcAliasListToClose = []
і               lcFilterExpr = [WHERE Form.FrmTypeID IN (1, 2) ]
і               lcJoinExpr = []
і               *------------------------------------------------------------------------------
і               
і               *02.06.2005 15:47 -> Создаем таблицу с окружением для отчёта
і               Create Table Tmp\RptEnv Free (QryParSID C(10))
і               Insert Into RptEnv (QryParSID) Values (tcQryParSID)
і               *------------------------------------------------------------------------------
і               
і               *08.07.2005 14:35 -> Сформируем условия выбора по дате
і               luQryParDateEnabled   = oQryParMgr.ParamGet(tcQryParSID,[qplDateEnabled])
і               luQryParDateStartDate = oQryParMgr.ParamGet(tcQryParSID,[qpdDateStart])
і               luQryParDateEndDate   = oQryParMgr.ParamGet(tcQryParSID,[qpdDateEnd])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryParDateEnabled)   And Type([luQryParDateEnabled])==[L]   And luQryParDateEnabled And ;
і       і                       !Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate) And ;
і       і                       !Isnull(luQryParDateEndDate)   And Type([luQryParDateEndDate])==[D]   And !Empty(luQryParDateEndDate)
і       і               
і       і               *08.07.2005 14:38 -> Сформируем условия выбора
і       і               lcFilterExpr = lcFilterExpr + [ AND TTOD(Form.FrmDate) BETWEEN {]+Dtoc(luQryParDateStartDate)+[} AND {]+Dtoc(luQryParDateEndDate)+[}]
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДElse
і       і               
і       і               *08.07.2005 14:40 -> Выведем сообщение о необходимости указать стартовую и конечную дату для построения отчёта
і       і               Messagebox([Для построения данного отчёта необходимо указать стартовую и конечную дату отчётного периода],48,[Предупреждение])
і       і               Return .F.
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *17.10.2005 11:02 -> Выберем все счета-фактуры за отчётный период
і               Select ;
і                       Form.frmid, ;
і                       Form.FrmParID, ;
і                       Form.FrmDate, ;
і                       FormReceipt.FrmDate As DtReceipt, ;
і                       Form.FrmNum, ;
і                       OrgUnit.cltid As OwnCltID, ;
і                       Form.PointEmiCltID As cltid ;
і                       FROM Form ;
і                       LEFT Join Form FormReceipt	On FormReceipt.frmid = Form.FrmParID And FormReceipt.FrmTypeId = 1 ;
і                       LEFT Join OrgUnit			On OrgUnit.Ouid = Form.PointIspOUID ;
і                       &lcFilterExpr ;
і                       INTO Table Tmp\tmpInvoice
і               *------------------------------------------------------------------------------
і               
і               *17.10.2005 11:22 -> Выбираем идентификаторы родителей документов-родителей
і               Select Distinct ;
і                       tmpInvoice.FrmParID As frmid, ;
і                       Form.FrmParID ;
і                       FROM tmpInvoice ;
і                       INNER Join Form On Form.frmid = tmpInvoice.FrmParID And Form.FrmParID # 0 ;
і                       INTO Cursor curPrevParentID NOFILTER
і               *------------------------------------------------------------------------------
і               
і               *17.10.2005 12:14 -> Найдем родителей самого верхнего уровня (нас интересуют полученные счета)
і       ЪДДДДДДДDo While _Tally > 0
і       і               
і       і               *17.10.2005 12:26 -> Выбираем родителей следующего уровня
і       і               Select ;
і       і                       curPrevParentID.frmid, ;
і       і                       Form.FrmParID ;
і       і                       FROM curPrevParentID ;
і       і                       INNER Join Form On Form.frmid = curPrevParentID.FrmParID And Form.FrmParID # 0 ;
і       і                       INTO Cursor curNextParentID
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *17.10.2005 12:26 -> Производим маппинг родителей (для достигших самого верхнего уровня)
і       і               Select ;
і       і                       curPrevParentID.frmid, ;
і       і                       curPrevParentID.FrmParID ;
і       і                       FROM curPrevParentID ;
і       і                       INNER Join Form On Form.frmid = curPrevParentID.FrmParID And Form.FrmParID = 0 ;
і       і                       INTO Cursor curNewParent
і       і               ***
і       і               Select curNewParent
і       і               ***
і       і       ЪДДДДДДДScan All
і       і       і               Replace FrmParID With curNewParent.FrmParID For FrmParID = curNewParent.frmid In tmpInvoice
і       і       АДДДДДДДEndscan
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *17.10.2005 12:28 -> Подготавливаем данные для следующей итерации
і       і               Select * From curNextParentID Into Cursor curPrevParentID NOFILTER
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEnddo
і               *------------------------------------------------------------------------------
і               
і               *20.10.2005 11:40 -> Закроем курсоры
і               Use In Select([curPrevParentID])
і               Use In Select([curNextParentID])
і               Use In Select([curNewParent])
і               *------------------------------------------------------------------------------
і               
і               *17.10.2005 11:02 -> Выберем все суммовые позиции по оплате счетов, связанных со счетами-фактурами
і               Select ;
і                       FrmPartFrm.frmid, ;
і                       FrmPartFrm.CntFrmId, ;
і                       Form.FrmDate As DtPayment, ;
і                       SUM(Iif(FrmPartFrmSum.FrmPartFrmSumVATRate>10,FrmPartFrmSum.FrmPartFrmSum,Ntom(0))) As FrmSum18, ;
і                       SUM(Iif(FrmPartFrmSum.FrmPartFrmSumVATRate>0 And FrmPartFrmSum.FrmPartFrmSumVATRate<14,FrmPartFrmSum.FrmPartFrmSum,Ntom(0))) As FrmSum10, ;
і                       SUM(Iif(FrmPartFrmSum.FrmPartFrmSumVATRate=0, FrmPartFrmSum.FrmPartFrmSum,Ntom(0))) As FrmSum0 ;
і                       FROM FrmPartFrm ;
і                       INNER Join Form			 On Form.frmid = FrmPartFrm.frmid ;
і                       INNER Join FrmPartFrmSum On FrmPartFrmSum.FrmPartFrmID = FrmPartFrm.FrmPartFrmID ;
і                       WHERE FrmPartFrm.CntFrmId In (Select FrmParID From tmpInvoice) ;
і                       GROUP By FrmPartFrm.frmid ;
і                       INTO Table Tmp\tmpPayment
і               *------------------------------------------------------------------------------
і               
і               *17.10.2005 11:02 -> Формируем итоговую выборку
і               Select ;
і                       tmpInvoice.frmid, ;
і                       tmpInvoice.FrmDate, ;
і                       tmpPayment.DtPayment, ;
і                       tmpInvoice.DtReceipt, ;
і                       tmpInvoice.FrmNum, ;
і                       tmpInvoice.OwnCltID, ;
і                       tmpInvoice.cltid, ;
і                       NVL(tmpPayment.FrmSum18,Ntom(0)) As FrmSum18, ;
і                       NVL(tmpPayment.FrmSum10,Ntom(0)) As FrmSum10, ;
і                       NVL(tmpPayment.FrmSum0, Ntom(0)) As FrmSum0 ;
і                       FROM tmpInvoice ;
і                       LEFT Join tmpPayment On tmpPayment.CntFrmId = tmpInvoice.FrmParID ;
і                       ORDER By tmpInvoice.OwnCltID,tmpInvoice.FrmDate ;
і                       INTO Table Tmp\RptItog
і               *------------------------------------------------------------------------------
і               
і               *20.10.2005 11:50 ->Закроем и удалим временную таблицу
і               Use In Select([tmpInvoice])
і               ***
і       ЪДДДДДДДIf File([tmp\tmpInvoice.dbf])
і       і               Erase Tmp\tmpInvoice.Dbf
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *20.10.2005 11:50 ->Закроем и удалим временную таблицу
і               Use In Select([tmpPayment])
і               ***
і       ЪДДДДДДДIf File([tmp\tmpPayment.dbf])
і       і               Erase Tmp\tmpPayment.Dbf
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *04.02.2005 11:17 -> Составим список идентификаторов клиентов, упоминающихся в документе
і               Select ;
і                       RptItog.cltid As Id;
і                       FROM RptItog ;
і                       UNION ;
і                       SELECT ;
і                       RptItog.OwnCltID As Id ;
і                       FROM RptItog ;
і                       INTO Cursor tmpCltIdList
і               *------------------------------------------------------------------------------
і               
і               *04.02.2005 11:17 -> Получим подробные данные по клиентам
і               spClientInfoExpand([tmpCltIdList],[RptCltInfo])
і               *------------------------------------------------------------------------------
і               
і               *26.01.2005 19:10 -> Вернем имя временных файлов, созданных для отчета
і               Return [RptItog.dbf;RptCltInfo.dbf;RptCltInfo.cdx;RptEnv.dbf]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spBookSaleReport()
        * Called by.......: <When Document Printed>
        * Parameters......: <tcQryParSID>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати книги покупок
        *-------------------------------------------------------
ЪДДДДДДДProcedure spBookSaleReport
і               Lparameters tcQryParSID
і               
і               *21.04.2004 12:31 -> Объявление и инициализация переменных
і               Local	lcFilterExpr, ;
і                       luQryParDateEnabled, ;
і                       luQryParDateStartDate, ;
і                       luQryParDateEndDate
і               ***
і               lcFilterExpr = [WHERE Form.FrmTypeID IN (4,3) ]
і               *------------------------------------------------------------------------------
і               
і               *02.06.2005 15:47 -> Создаем таблицу с окружением для отчёта
і               Create Table Tmp\RptEnv Free (QryParSID C(10))
і               Insert Into RptEnv (QryParSID) Values (tcQryParSID)
і               *------------------------------------------------------------------------------
і               
і               *08.07.2005 14:35 -> Сформируем условия выбора по дате
і               luQryParDateEnabled   = oQryParMgr.ParamGet(tcQryParSID,[qplDateEnabled])
і               luQryParDateStartDate = oQryParMgr.ParamGet(tcQryParSID,[qpdDateStart])
і               luQryParDateEndDate   = oQryParMgr.ParamGet(tcQryParSID,[qpdDateEnd])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryParDateEnabled)   And Type([luQryParDateEnabled])==[L]   And luQryParDateEnabled And ;
і       і                       !Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate) And ;
і       і                       !Isnull(luQryParDateEndDate)   And Type([luQryParDateEndDate])==[D]   And !Empty(luQryParDateEndDate)
і       і               
і       і               *08.07.2005 14:38 -> Сформируем условия выбора
і       і               lcFilterExpr = lcFilterExpr + [ AND TTOD(Form.FrmDate) BETWEEN {]+Dtoc(luQryParDateStartDate)+[} AND {]+Dtoc(luQryParDateEndDate)+[}]
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДElse
і       і               
і       і               *08.07.2005 14:40 -> Выведем сообщение о необходимости указать стартовую и конечную дату для построения отчёта
і       і               Messagebox([Для построения данного отчёта необходимо указать стартовую и конечную дату отчётного периода],48,[Предупреждение])
і       і               Return .F.
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *17.10.2005 11:02 -> Выберем все счета-фактуры за отчётный период
і               Select ;
і                       Form.frmid, ;
і                       Form.FrmParID, ;
і                       Form.FrmDate, ;
і                       Form.FrmNum, ;
і                       OrgUnit.cltid As OwnCltID, ;
і                       Form.PointIspCltID As cltid ;
і                       FROM Form ;
і                       LEFT Join OrgUnit On OrgUnit.Ouid = Form.PointEmiOUID ;
і                       &lcFilterExpr ;
і                       INTO Table Tmp\tmpInvoice
і               *------------------------------------------------------------------------------
і               
і               *17.10.2005 11:22 -> Выбираем идентификаторы родителей документов-родителей
і               Select Distinct ;
і                       tmpInvoice.FrmParID As frmid, ;
і                       Form.FrmParID ;
і                       FROM tmpInvoice ;
і                       INNER Join Form On Form.frmid = tmpInvoice.FrmParID And Form.FrmParID # 0 ;
і                       INTO Cursor curPrevParentID NOFILTER
і               *------------------------------------------------------------------------------
і               
і               *17.10.2005 12:14 -> Найдем родителей самого верхнего уровня (нас интересуют полученные счета)
і       ЪДДДДДДДDo While _Tally > 0
і       і               
і       і               *17.10.2005 12:26 -> Выбираем родителей следующего уровня
і       і               Select ;
і       і                       curPrevParentID.frmid, ;
і       і                       Form.FrmParID ;
і       і                       FROM curPrevParentID ;
і       і                       INNER Join Form On Form.frmid = curPrevParentID.FrmParID And Form.FrmParID # 0 ;
і       і                       INTO Cursor curNextParentID
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *17.10.2005 12:26 -> Производим маппинг родителей (для достигших самого верхнего уровня)
і       і               Select ;
і       і                       curPrevParentID.frmid, ;
і       і                       curPrevParentID.FrmParID ;
і       і                       FROM curPrevParentID ;
і       і                       INNER Join Form On Form.frmid = curPrevParentID.FrmParID And Form.FrmParID = 0 ;
і       і                       INTO Cursor curNewParent
і       і               ***
і       і               Select curNewParent
і       і               ***
і       і       ЪДДДДДДДScan All
і       і       і               Replace FrmParID With curNewParent.FrmParID For FrmParID = curNewParent.frmid In tmpInvoice
і       і       АДДДДДДДEndscan
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *17.10.2005 12:28 -> Подготавливаем данные для следующей итерации
і       і               Select * From curNextParentID Into Cursor curPrevParentID NOFILTER
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEnddo
і               *------------------------------------------------------------------------------
і               
і               *20.10.2005 11:40 -> Закроем курсоры
і               Use In Select([curPrevParentID])
і               Use In Select([curNextParentID])
і               Use In Select([curNewParent])
і               *------------------------------------------------------------------------------
і               
і               *17.10.2005 11:02 -> Выберем все суммовые позиции по оплате счетов, связанных со счетами-фактурами
і               Select ;
і                       FrmPartFrm.frmid, ;
і                       FrmPartFrm.CntFrmId, ;
і                       Form.FrmDate As DtPayment, ;
і                       SUM(Iif(FrmPartFrmSum.FrmPartFrmSumVATRate>10,FrmPartFrmSum.FrmPartFrmSum,Ntom(0))) As FrmSum18, ;
і                       SUM(Iif(FrmPartFrmSum.FrmPartFrmSumVATRate>0 And FrmPartFrmSum.FrmPartFrmSumVATRate<14,FrmPartFrmSum.FrmPartFrmSum,Ntom(0))) As FrmSum10, ;
і                       SUM(Iif(FrmPartFrmSum.FrmPartFrmSumVATRate=0, FrmPartFrmSum.FrmPartFrmSum,Ntom(0))) As FrmSum0 ;
і                       FROM FrmPartFrm ;
і                       INNER Join Form			 On Form.frmid = FrmPartFrm.frmid ;
і                       INNER Join FrmPartFrmSum On FrmPartFrmSum.FrmPartFrmID = FrmPartFrm.FrmPartFrmID ;
і                       WHERE FrmPartFrm.CntFrmId In (Select FrmParID From tmpInvoice) ;
і                       GROUP By FrmPartFrm.frmid ;
і                       INTO Table Tmp\tmpPayment
і               *------------------------------------------------------------------------------
і               
і               *17.10.2005 11:02 -> Формируем итоговую выборку
і               Select ;
і                       tmpInvoice.frmid, ;
і                       tmpInvoice.FrmDate, ;
і                       tmpPayment.DtPayment, ;
і                       tmpInvoice.FrmNum, ;
і                       tmpInvoice.OwnCltID, ;
і                       tmpInvoice.cltid, ;
і                       NVL(tmpPayment.FrmSum18,Ntom(0)) As FrmSum18, ;
і                       NVL(tmpPayment.FrmSum10,Ntom(0)) As FrmSum10, ;
і                       NVL(tmpPayment.FrmSum0, Ntom(0)) As FrmSum0 ;
і                       FROM tmpInvoice ;
і                       LEFT Join tmpPayment On tmpPayment.CntFrmId = tmpInvoice.FrmParID ;
і                       ORDER By tmpInvoice.OwnCltID,tmpInvoice.FrmDate ;
і                       INTO Table Tmp\RptItog
і               *------------------------------------------------------------------------------
і               
і               *20.10.2005 11:50 ->Закроем и удалим временную таблицу
і               Use In Select([tmpInvoice])
і               ***
і       ЪДДДДДДДIf File([tmp\tmpInvoice.dbf])
і       і               Erase Tmp\tmpInvoice.Dbf
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *20.10.2005 11:50 ->Закроем и удалим временную таблицу
і               Use In Select([tmpPayment])
і               ***
і       ЪДДДДДДДIf File([tmp\tmpPayment.dbf])
і       і               Erase Tmp\tmpPayment.Dbf
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *04.02.2005 11:17 -> Составим список идентификаторов клиентов, упоминающихся в документе
і               Select ;
і                       RptItog.cltid As Id;
і                       FROM RptItog ;
і                       UNION ;
і                       SELECT ;
і                       RptItog.OwnCltID As Id ;
і                       FROM RptItog ;
і                       INTO Cursor tmpCltIdList
і               *------------------------------------------------------------------------------
і               
і               *04.02.2005 11:17 -> Получим подробные данные по клиентам
і               spClientInfoExpand([tmpCltIdList],[RptCltInfo])
і               *------------------------------------------------------------------------------
і               
і               *26.01.2005 19:10 -> Вернем имя временных файлов, созданных для отчета
і               Return [RptItog.dbf;RptCltInfo.dbf;RptCltInfo.cdx;RptEnv.dbf]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spCardAccessSale()
        * Called by.......: <When Document Printed>
        * Parameters......: <tcQryParSID>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати отчёта по продажам карт доступа на подьемник
        *-----------------------------------------------------------------------------------
ЪДДДДДДДProcedure spCardAccessSale
і               Lparameters tcQryParSID
і               
і               *21.04.2004 12:31 -> Объявление и инициализация переменных
і               Local	lcOldDate, ;
і                       lcOldCentury, ;
і                       lcOldMark, ;
і                       lcFilterExpr, ;
і                       luQryParDateEnabled, ;
і                       luQryParDateStartDate, ;
і                       luQryParDateEndDate, ;
і                       luQryCltEnabled, ;
і                       luQryCltTableNM, ;
і                       lcValueList, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldDate = Set([DATE])
і               lcOldCentury = Set([CENTURY])
і               lcOldMark = Set([MARK])
і               lcFilterExpr = [WHERE 1 <> 272]
і               *------------------------------------------------------------------------------
і               *****************************************************************************
і               * 1. Сохраним идентификатор сессии параметров для использования в отчёте	*
і               *****************************************************************************
і               
і               *02.06.2005 15:47 -> Создаем таблицу с окружением для отчёта
і               Create Table Tmp\RptEnv Free (QryParSID C(10))
і               Insert Into RptEnv (QryParSID) Values (tcQryParSID)
і               *------------------------------------------------------------------------------
і               
і               *****************************************************************************
і               * 2. Сформируем условия выбора данных										*
і               *****************************************************************************
і               
і               *08.07.2005 14:35 -> Сформируем условия выбора по дате
і               luQryParDateEnabled   = oQryParMgr.ParamGet(tcQryParSID,[qplDateEnabled])
і               luQryParDateStartDate = oQryParMgr.ParamGet(tcQryParSID,[qpdDateStart])
і               luQryParDateEndDate   = oQryParMgr.ParamGet(tcQryParSID,[qpdDateEnd])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryParDateEnabled)   And Type([luQryParDateEnabled])==[L]   And luQryParDateEnabled And ;
і       і                       !Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate) And ;
і       і                       !Isnull(luQryParDateEndDate)   And Type([luQryParDateEndDate])==[D]   And !Empty(luQryParDateEndDate)
і       і               
і       і               *21.04.2006 10:33 -> Установим формат даты YMD и CENTURY ON
і       і               Set Date YMD
і       і               ***
і       і               Set Century On
і       і               ***
і       і               Set Mark To "/"
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *06.12.2007 14:38 -> Сформируем условия выбора
і       і               lcFilterExpr = lcFilterExpr + [  AND AccessTvrSum.AccesDate >= ']+Strtran(Dtoc(luQryParDateStartDate),[/],[]);
і       і                       +[' AND AccessTvrSum.AccesDate <= ']+Strtran(Dtoc(luQryParDateEndDate),[/],[])+[']
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *21.04.2006 10:33 -> Восстановим старый формат даты
і       і               Set Date (lcOldDate)
і       і               ***
і       і               Set Century &lcOldCentury
і       і               ***
і       і               Set Mark To lcOldMark
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДElse
і       і               
і       і               *08.07.2005 14:40 -> Выведем сообщение о необходимости указать стартовую и конечную дату для построения отчёта
і       і               spHandleODBCError()
і       і               Return .F.
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *28.05.2004 00:32 -> Формируем условие выбора по владельцу карты
і               luQryCltEnabled   = oQryParMgr.ParamGet(tcQryParSID,[qplCltEnabled])
і               luQryCltTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCltIDTableNM])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryCltEnabled)   And Type([luQryCltEnabled])==[L]   And luQryCltEnabled And ;
і       і                       !Isnull(luQryCltTableNM) And Type([luQryCltTableNM])==[C]
і       і               
і       і               *08.12.2007 14:38 -> Сформируем условия выбора
і       і               lcValueList = spGetTmpValueList(luQryCltTableNM)
і       і               ***
і       і               lcFilterExpr = lcFilterExpr + [ AND AccessTvrSum.CardOwnerID IN (] + lcValueList + [)]
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.T.)
і               *------------------------------------------------------------------------------
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spCardAccessSale ?lcFilterExpr],[RptItog])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               Select RptItog
і               Copy To Tmp\RptItog.Dbf
і               ***
і               Use In Select([RptItog])
і               
і               
і               
і               *26.01.2005 19:10 -> Вернем список файлов созданных для отчета
і               Return [RptItog.dbf]  &&;RptItog.cdx]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spCardAccessStat()
        * Called by.......: <When Document Printed>
        * Parameters......: <tcQryParSID>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати отчёта по картам доступа
        *-------------------------------------------------------
ЪДДДДДДДProcedure spCardAccessStat
і               Lparameters tcQryParSID
і               
і               *21.04.2004 12:31 -> Объявление и инициализация переменных
і               Local	lcOldDate, ;
і                       lcOldCentury, ;
і                       lcOldMark, ;
і                       lcFilterExpr, ;
і                       luQryParDateEnabled, ;
і                       luQryParDateStartDate, ;
і                       luQryParDateEndDate, ;
і                       luQryCltEnabled, ;
і                       luQryCltTableNM, ;
і                       lcValueList, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldDate = Set([DATE])
і               lcOldCentury = Set([CENTURY])
і               lcOldMark = Set([MARK])
і               lcFilterExpr = [WHERE 1 <> 272]
і               *------------------------------------------------------------------------------
і               
і               *****************************************************************************
і               * 1. Сохраним идентификатор сессии параметров для использования в отчёте	*
і               *****************************************************************************
і               
і               *02.06.2005 15:47 -> Создаем таблицу с окружением для отчёта
і               Create Table Tmp\RptEnv Free (QryParSID C(10))
і               Insert Into RptEnv (QryParSID) Values (tcQryParSID)
і               *------------------------------------------------------------------------------
і               
і               *****************************************************************************
і               * 2. Сформируем условия выбора данных										*
і               *****************************************************************************
і               
і               *08.07.2005 14:35 -> Сформируем условия выбора по дате
і               luQryParDateEnabled   = oQryParMgr.ParamGet(tcQryParSID,[qplDateEnabled])
і               luQryParDateStartDate = oQryParMgr.ParamGet(tcQryParSID,[qpdDateStart])
і               luQryParDateEndDate   = oQryParMgr.ParamGet(tcQryParSID,[qpdDateEnd])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryParDateEnabled)   And Type([luQryParDateEnabled])==[L]   And luQryParDateEnabled And ;
і       і                       !Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate) And ;
і       і                       !Isnull(luQryParDateEndDate)   And Type([luQryParDateEndDate])==[D]   And !Empty(luQryParDateEndDate)
і       і               
і       і               *21.04.2006 10:33 -> Установим формат даты YMD и CENTURY ON
і       і               Set Date YMD
і       і               ***
і       і               Set Century On
і       і               ***
і       і               Set Mark To "/"
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *06.12.2007 14:38 -> Сформируем условия выбора
і       і               lcFilterExpr = lcFilterExpr + [  AND CardStatTime.AccesDate >= ']+Strtran(Dtoc(luQryParDateStartDate),[/],[]);
і       і                       +[' AND CardStatTime.AccesDate <= ']+Strtran(Dtoc(luQryParDateEndDate+1),[/],[])+[']
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *21.04.2006 10:33 -> Восстановим старый формат даты
і       і               Set Date (lcOldDate)
і       і               ***
і       і               Set Century &lcOldCentury
і       і               ***
і       і               Set Mark To lcOldMark
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДElse
і       і               
і       і               *08.07.2005 14:40 -> Выведем сообщение о необходимости указать стартовую и конечную дату для построения отчёта
і       і               spHandleODBCError()
і       і               Return .F.
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *28.05.2004 00:32 -> Формируем условие выбора по владельцу карты
і               luQryCltEnabled   = oQryParMgr.ParamGet(tcQryParSID,[qplCltEnabled])
і               luQryCltTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCltIDTableNM])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryCltEnabled)   And Type([luQryCltEnabled])==[L]   And luQryCltEnabled And ;
і       і                       !Isnull(luQryCltTableNM) And Type([luQryCltTableNM])==[C]
і       і               
і       і               *08.12.2007 14:38 -> Сформируем условия выбора
і       і               lcValueList = spGetTmpValueList(luQryCltTableNM)
і       і               ***
і       і               lcFilterExpr = lcFilterExpr + [ AND CardStatTime.CardOwnerID IN (] + lcValueList + [)]
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.T.)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spCardAccessStat ?lcFilterExpr],[RptItog])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               Select RptItog
і               Copy To Tmp\RptItog.Dbf
і               ***
і               Use In Select([RptItog])
і               
і               
і               
і               *26.01.2005 19:10 -> Вернем список файлов созданных для отчета
і               Return [RptItog.dbf]  &&;RptItog.cdx]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spCheckReset()
        * Called by.......: <NA>
        * Parameters......: <tnCheckID>
        * Returns.........: <none>
        * Notes...........: Сброс чека
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spCheckReset
і               Lparameters tnCheckID
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Сбрасываем чек
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [UPDATE CheckSale ] + ;
і       і                       [SET CheckTypeID = ABS(CheckTypeID) + 3 ] + ;
і       і                       [WHERE CheckID = ?tnCheckID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spCheckReset_old() резервный вариант
        * Called by.......: <NA>
        * Parameters......: <tnCheckID>
        * Returns.........: <none>
        * Notes...........: Сброс чека
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spCheckReset_old
і               Lparameters tnCheckID
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Сбрасываем чек
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [UPDATE CheckSale ] + ;
і       і                       [SET CheckTypeID = CheckTypeID + 3 ] + ;
і       і                       [WHERE CheckID = ?tnCheckID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spCheckSaleSucces()
        * Called by.......: <NA>
        * Parameters......: <tnCheckID>
        * Returns.........: <none>
        * Notes...........: Фиксирование нормального завершения чека
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spCheckSaleSucces
і               Lparameters tnCheckID
і               
і               *10.10.2006 16:26 ->Объявление и инициализация переменных
і               Local   lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       llResult
і               *------------------------------------------------------------------------------
і               
і               *10.10.2006 16:26 ->Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *10.10.2006 16:26 ->Отмечаем чек
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [UPDATE CheckSale ] + ;
і       і                       [SET CheckAttributeID = CheckAttributeID & (~4) ] + ;
і       і                       [WHERE CheckID = ?tnCheckID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *10.10.2006 16:26 ->Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spCheckView()
        * Called by.......: <NA>
        * Parameters......: <tcQryParSID>
        * Returns.........: <none>
        * Notes...........: Список чеков
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spCheckView
і               Lparameters tcQryParSID
і               
і               *28.02.2006 12:16 ->Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lcOldDate, ;
і                       lcOldCentury, ;
і                       lcOldMark, ;
і                       lcUniqueName, ;
і                       lcUniqueFilePath, ;
і                       lcFilterExpr, ;
і                       luQryParDateEnabled, ;
і                       luQryParDateStartDate, ;
і                       luQryParDateEndDate, ;
і                       luQryParCashEnabled, ;
і                       luQryParCashTableNM, ;
і                       luQryParCashierEnabled, ;
і                       luQryParCashierTableNM, ;
і                       luQryParTvrEnabled, ;
і                       luQryParTvrIDTableNM, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldAlias = Alias()
і               lcOldDate = Set([DATE])
і               lcOldCentury = Set([CENTURY])
і               lcOldMark = Set([MARK])
і               lcFilterExpr   = []
і               lcUniqueName = [_sl]+Sys(2015)
і               lcUniqueFilePath = [tmp\] + lcUniqueName + [.DBF]
і               *------------------------------------------------------------------------------
і               
і               *07.07.2006 16:38 -> Вывод сообщения пользователю
і               Set Message To [Идет подготовка данных...]
і               Wait Window [Идет подготовка данных...] Nowait Noclear
і               *------------------------------------------------------------------------------
і               
і               *28.02.2006 14:52 ->Дальнейшие параметры обрабатываем, если существует менеджер параметров
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *07.12.2005 11:37 ->Формируем фильтр по дате
і       і               luQryParDateEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplDateEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParDateEnabled) And Type([luQryParDateEnabled])==[L] And luQryParDateEnabled
і       і       і               
і       і       і               *26.05.2004 21:33 ->Получим дату стартовую и конечную
і       і       і               luQryParDateStartDate = oQryParMgr.ParamGet(tcQryParSID,[qpdDateStart])
і       і       і               luQryParDateEndDate = oQryParMgr.ParamGet(tcQryParSID,[qpdDateEnd])
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *21.04.2006 10:33 -> Установим формат даты YMD и CENTURY ON
і       і       і               Set Date YMD
і       і       і               ***
і       і       і               Set Century On
і       і       і               ***
і       і       і               Set Mark To "/"
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *26.05.2004 21:27 ->Формируем условие
і       і       і       ЪДДДДДДДDo Case
і       і       і       ГДДДДДДДCase	!Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate) And ;
і       і       і       і                       !Isnull(luQryParDateEndDate) And Type([luQryParDateEndDate])==[D] And !Empty(luQryParDateEndDate)
і       і       і       і               *{
і       і       і       і               lcFilterExpr = lcFilterExpr + [ AND CheckStamp >= ']+Strtran(Dtoc(luQryParDateStartDate),[/],[])+[' AND CheckStamp < ']+Strtran(Dtoc(luQryParDateEndDate+1),[/],[])+[']
і       і       і       і               *}
і       і       і       ГДДДДДДДCase	!Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate)
і       і       і       і               *{
і       і       і       і               lcFilterExpr = lcFilterExpr + [ AND CheckStamp >= ']+Strtran(Dtoc(luQryParDateStartDate),[/],[])+[']
і       і       і       і               *}
і       і       і       ГДДДДДДДCase	!Isnull(luQryParDateEndDate) And Type([luQryParDateEndDate])==[D] And !Empty(luQryParDateEndDate)
і       і       і       і               *{
і       і       і       і               lcFilterExpr = lcFilterExpr + [ AND CheckStamp < ']+Strtran(Dtoc(luQryParDateEndDate+1),[/],[])+[']
і       і       і       і               *}
і       і       і       АДДДДДДДEndcase
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *21.04.2006 10:33 -> Восстановим старый формат даты
і       і       і               Set Date (lcOldDate)
і       і       і               ***
і       і       і               Set Century &lcOldCentury
і       і       і               ***
і       і       і               Set Mark To lcOldMark
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *02.06.2006 11:34 ->Формируем фильтр по кассе
і       і               luQryParCashEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCashEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParCashEnabled) And Type([luQryParCashEnabled])==[L] And luQryParCashEnabled
і       і       і               luQryParCashTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCashTableNM])
і       і       і       ЪДДДДДДДIf !Isnull(luQryParCashTableNM) And Type([luQryParCashTableNM])==[C] And File(luQryParCashTableNM+[.dbf])
і       і       і       і               
і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і               lcFilterExpr = lcFilterExpr+[ AND CheckCashID IN (] + spGetTmpValueList(luQryParCashTableNM) + [)]
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *02.06.2006 11:34 ->Формируем фильтр по кассиру
і       і               luQryParCashierEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCashierEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParCashierEnabled) And Type([luQryParCashierEnabled])==[L] And luQryParCashierEnabled
і       і       і               luQryParCashierTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCashierTableNM])
і       і       і       ЪДДДДДДДIf !Isnull(luQryParCashierTableNM) And Type([luQryParCashierTableNM])==[C] And File(luQryParCashierTableNM+[.dbf])
і       і       і       і               
і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і               lcFilterExpr = lcFilterExpr+[ AND CheckCashierID IN (] + spGetTmpValueList(luQryParCashierTableNM) + [)]
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *02.06.2006 11:38 ->Формируем фильтр (Выбор товаров)
і       і               luQryParTvrEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplTvrEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParTvrEnabled) And Type([luQryParTvrEnabled])==[L] And luQryParTvrEnabled
і       і       і               
і       і       і               *23.04.2006 00:32 ->Получим имя временной таблицы с идентификаторами товАРОВ
і       і       і               luQryParTvrIDTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcTvrIDTableNM])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParTvrIDTableNM) And Type([luQryParTvrIDTableNM])==[C] And File([tmp\]+luQryParTvrIDTableNM+[.dbf])
і       і       і       і               
і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і                       [ AND CheckID IN (SELECT CheckID FROM CheckTrans WHERE CheckTrans.CheckTransTvrId IN (]+spGetTmpValueList(luQryParTvrIDTableNM)+[))]
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і       ЪДДДДДДДIf Empty(tcQryParSID)
і       і               Set Date YMD
і       і               Set Century On
і       і               Set Mark To "/"
і       і               lcFilterExpr = [ AND CheckStamp BETWEEN ']+Strtran(Dtoc(Date()),[/],[])+[' AND ']+Strtran(Dtoc(Date()),[/],[])+[']
і       і               Set Date (lcOldDate)
і       і               Set Century &lcOldCentury
і       і               Set Mark To lcOldMark
і       АДДДДДДДEndif
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spCheckView ?lcFilterExpr],lcUniqueName)
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *11.08.2006 17:00 ->Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.08.2006 17:01 ->Сформируем пустой курсор
і       і               Create Cursor (lcUniqueName) ( ;
і       і                       CheckID I, BranchID I, BranchNM C(1), ChkTypeNM C(1), CheckNo I, CashNM C(1), ;
і       і                       CashierNM C(1), CheckStamp T, DiscCardNo C(1),CheckSum I;
і       і                       )
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсор в файл и закроем
і               Select (lcUniqueName)
і               ***
і               Copy To (lcUniqueFilePath)
і               ***
і               Use In Select(lcUniqueName)
і               *------------------------------------------------------------------------------
і               
і               *02.06.2006 12:24 ->Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.07.2006 16:39 -> Очистим сообщение
і               Wait Clear
і               Set Message To []
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 14:27 -> Вернем значение
і               Return lcUniqueName
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spClientInfoExpand()
        * Called by.......: <NA>
        * Parameters......: <tcCltIdListTable, tcCltListTable>
        * Returns.........: <none>
        * Notes...........: Выборка информации о клиентах
        *-------------------------------------------------------
ЪДДДДДДДProcedure spClientInfoExpand
і               Lparameters	tcCltIdListTable, tcCltListTable
і               
і               *24.04.2006 12:49 ->Объявление и инициализация переменных
і               Local	lcFilterExpr, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *21.04.2006 16:14 -> Сформируем строку со списком идентификаторов клиентов
і               lcFilterExpr = spGetTmpValueList(tcCltIdListTable)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос (получим подробные данные по клиентам)
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spClientInfoExpand ?lcFilterExpr],[curCltList])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *11.08.2006 16:02 ->Вазовем обработчик ошибок
і       і               spHandleODBCError()
і       і               *------------------------------------------------------------------------------
і       і               
і       і               Return
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *15.09.2004 11:53 -> Cделаем конкатенацию
і               Select ;
і                       curCltList.cltid, ;
і                       curCltList.CltNM, ;
і                       LTRIM(Alltrim(curCltList.CltLTAbbr) + ;
і                       [ ]+Alltrim(curCltList.CltJrdNM) + ;
і                       ALLTRIM(curCltList.CltFIO)) As CltFullNM, ;
і                       LTRIM(Alltrim(curCltList.CltLTAbbr) + ;
і                       [ ]+Alltrim(curCltList.CltJrdNM) + ;
і                       ALLTRIM(curCltList.CltFIO_)) As CltFullNM_, ;
і                       SUBSTR(Padr(Iif(!Empty(curCltList.CltFullINN),[, ]+Alltrim(curCltList.CltFullINN),[]) + ;
і                       IIF(!Empty(curCltList.CltFullKpp),[, ]+Alltrim(curCltList.CltFullKpp),[]),254),3) As CltInnKpp, ;
і                       SUBSTR(Padr(Iif(curCltList.CltAddrZIP>0, [, ]+Alltrim(Str(curCltList.CltAddrZIP)), []) + ;
і                       IIF(!Empty(curCltList.CltAddrReg), [, ]+Alltrim(curCltList.CltAddrReg), []) + ;
і                       IIF(!Empty(curCltList.CltAddrStl), [, ]+Alltrim(curCltList.CltAddrStl), []) + ;
і                       IIF(!Empty(curCltList.CltAddrStr), [, ]+Alltrim(curCltList.CltAddrStr), []) + ;
і                       IIF(!Empty(curCltList.CltAddrHs), [, ]+Alltrim(curCltList.CltAddrHs), []) + ;
і                       IIF(!Empty(curCltList.CltAddrRm), [, ]+Alltrim(curCltList.CltAddrRm), []) + ;
і                       IIF(!Empty(curCltList.CltTel), [, ]+Alltrim(curCltList.CltTel), []), 254),3) As CltFullAdr, ;
і                       PADR(Ltrim(Iif(!Empty(curCltList.CltPhPSer), [ серия ]+Alltrim(curCltList.CltPhPSer), []) + ;
і                       IIF(!Empty(curCltList.CltPhPNum), [ номер ]+Alltrim(curCltList.CltPhPNum), []) + ;
і                       IIF(!Empty(curCltList.CltPhPID) Or !Empty(curCltList.CltPhPIB), [ выдан], []) + ;
і                       IIF(!Empty(curCltList.CltPhPIB), [ ]+Alltrim(curCltList.CltPhPIB), []) + ;
і                       IIF(!Empty(curCltList.CltPhPID), [ ]+Dtoc(Ttod(curCltList.CltPhPID)), [])), 254) As CltFullPh, ;
і                       curCltList.CltTypeID, ;
і                       curCltList.CltINN, ;
і                       curCltList.CltFullINN, ;
і                       curCltList.CltAddrZIP, ;
і                       curCltList.CltAddrReg, ;
і                       curCltList.CltAddrStl, ;
і                       curCltList.CltAddrStr, ;
і                       curCltList.CltAddrHs, ;
і                       curCltList.CltAddrRm, ;
і                       curCltList.CltTel, ;
і                       curCltList.CltJrdNM, ;
і                       curCltList.CltJrdKpp, ;
і                       curCltList.CltFullKPP, ;
і                       curCltList.CltLTAbbr, ;
і                       curCltList.CltLTNM, ;
і                       curCltList.CltPhysFNM, ;
і                       curCltList.CltPhysINM, ;
і                       curCltList.CltPhysONM, ;
і                       curCltList.CltFIO, ;
і                       curCltList.CltFIO_, ;
і                       curCltList.CltPhBDate, ;
і                       curCltList.CltPhPSer, ;
і                       curCltList.CltPhPNum, ;
і                       curCltList.CltPhPID, ;
і                       curCltList.CltPhPIB, ;
і                       curCltList.CltPhPDate ;
і                       FROM curCltList ;
і                       INTO Table ([tmp\]+tcCltListTable)
і               *------------------------------------------------------------------------------
і               
і               *16.09.2004 15:55 ->Создадим индекс для Relation-а
і               Select (tcCltListTable)
і               Index On cltid Tag cltid &&OF ([tmp\]+tcCltListTable)
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spClientInfoExpandVFP()
        * Called by.......: <NA>
        * Parameters......: <tcCltIdListTable, tcCltListTable>
        * Returns.........: <none>
        * Notes...........: Выборка информации о клиентах
        *-------------------------------------------------------
ЪДДДДДДДProcedure spClientInfoExpandVFP
і               Lparameters	tcCltIdListTable, tcCltListTable
і               
і               *25.08.2004 11:44 -> Выберем информацию о клиентах
і               Select ;
і                       CltIdList.cltid, ;
і                       Client.CltNM, ;
і                       Client.CltTypeID, ;
і                       Client.CltINN, ;
і                       PADR(Iif(Client.CltINN>0,[ИНН ]+Alltrim(Str(Client.CltINN,12,0)),[]),254) As CltFullINN, ;
і                       NVL(CltAddress.CltAddrZIP, 000000) As CltAddrZIP, ;
і                       NVL(CltAddress.CltAddrRegNM, Space(40)) As CltAddrReg, ;
і                       NVL(CltAddress.CltAddrAreaNM, Space(40)) As CltAddrAr, ;
і                       NVL(CltAddress.CltAddrSettlNM, Space(40)) As CltAddrStl, ;
і                       NVL(CltAddress.CltAddrStreetNM, Space(40)) As CltAddrStr, ;
і                       NVL(CltAddress.CltAddrHouseNM, Space(40)) As CltAddrHs, ;
і                       NVL(CltAddress.CltAddrRoom, Space(40)) As CltAddrRm, ;
і                       NVL(CltTel.CltTelNumber, Space(20)) As CltTel, ;
і                       NVL(CltJuridical.CltJrdNM, Space(40)) As CltJrdNM, ;
і                       NVL(CltJuridical.CltJrdKpp, 000000000)  As CltJrdKpp, ;
і                       PADR(Iif(!Isnull(CltJuridical.CltJrdKpp) And CltJuridical.CltJrdKpp>0,[КПП ] + Alltrim(Str(CltJuridical.CltJrdKpp)),[]),254) As CltFullKPP, ;
і                       NVL(CltLegalType.CltLegalTypeAbbr, Space(20)) As CltLTAbbr, ;
і                       NVL(CltLegalType.CltLegalTypeNM, Space(40)) As CltLTNM, ;
і                       NVL(CltPhysical.CltPhysFNM, Space(40)) As CltPhysFNM, ;
і                       NVL(CltPhysical.CltPhysINM, Space(40)) As CltPhysINM, ;
і                       NVL(CltPhysical.CltPhysONM, Space(40)) As CltPhysONM, ;
і                       PADR(Ltrim(Iif(!Isnull(CltPhysical.CltPhysFNM) And !Empty(CltPhysical.CltPhysFNM),[ ]+Alltrim(CltPhysical.CltPhysFNM),[]) + ;
і                       IIF(!Isnull(CltPhysical.CltPhysINM) And !Empty(CltPhysical.CltPhysINM),[ ]+Alltrim(CltPhysical.CltPhysINM),[]) + ;
і                       IIF(!Isnull(CltPhysical.CltPhysONM) And !Empty(CltPhysical.CltPhysONM),[ ]+Alltrim(CltPhysical.CltPhysONM),[])),254) As CltFIO, ;
і                       PADR(Ltrim(Iif(!Isnull(CltPhysical.CltPhysFNM) And !Empty(CltPhysical.CltPhysFNM),[ ]+Alltrim(CltPhysical.CltPhysFNM),[]) + ;
і                       IIF(!Isnull(CltPhysical.CltPhysINM) And !Empty(CltPhysical.CltPhysINM),[ ]+Left(Ltrim(CltPhysical.CltPhysINM),1)+[.],[]) + ;
і                       IIF(!Isnull(CltPhysical.CltPhysONM) And !Empty(CltPhysical.CltPhysONM),[ ]+Left(Ltrim(CltPhysical.CltPhysONM),1)+[.],[])),254) As CltFIO_, ;
і                       NVL(CltPhysical.CltPhysBirthDate, Ctot([])) As CltPhBDate, ;
і                       NVL(CltPhysPassp.CltPhysPasspSeries, Space(20)) As CltPhPSer, ;
і                       NVL(CltPhysPassp.CltPhysPasspNumber, Space(20)) As CltPhPNum, ;
і                       NVL(CltPhysPassp.CltPhysPasspIssueDate, Ctot([])) As CltPhPID, ;
і                       NVL(CltPhysPassp.CltPhysPasspIssueBy, Space(100)) As CltPhPIB, ;
і                       NVL(CltPhysPassp.CltPhysPasspExpDate,Ctot([])) As CltPhPDate ;
і                       FROM (tcCltIdListTable) CltIdList;
і                       INNER Join Client On CltIdList.cltid = Client.cltid ;
і                       LEFT Join CltAddress On CltIdList.cltid = CltAddress.cltid And CltAddress.CltAddrIsMain ;
і                       LEFT Join CltTel On CltIdList.cltid = CltTel.cltid And CltTel.CltTelIsMain ;
і                       LEFT Join CltPhysical On CltIdList.cltid = CltPhysical.cltid ;
і                       LEFT Join CltJuridical On CltIdList.cltid = CltJuridical.cltid ;
і                       LEFT Join CltPhysPassp On CltIdList.cltid = CltPhysPassp.cltid ;
і                       LEFT Join CltLegalType On CltJuridical.CltLegalTypeID = CltLegalType.CltLegalTypeID ;
і                       INTO Cursor curCltList NOFILTER
і               *------------------------------------------------------------------------------
і               
і               *15.09.2004 11:53 -> Cделаем конкатенацию
і               Select ;
і                       curCltList.cltid, ;
і                       curCltList.CltNM, ;
і                       LTRIM(Alltrim(curCltList.CltLTAbbr) + ;
і                       [ ]+Alltrim(curCltList.CltJrdNM) + ;
і                       ALLTRIM(curCltList.CltFIO)) As CltFullNM, ;
і                       LTRIM(Alltrim(curCltList.CltLTAbbr) + ;
і                       [ ]+Alltrim(curCltList.CltJrdNM) + ;
і                       ALLTRIM(curCltList.CltFIO_)) As CltFullNM_, ;
і                       SUBSTR(Padr(Iif(!Empty(curCltList.CltFullINN),[, ]+Alltrim(curCltList.CltFullINN),[]) + ;
і                       IIF(!Empty(curCltList.CltFullKpp),[, ]+Alltrim(curCltList.CltFullKpp),[]),254),3) As CltInnKpp, ;
і                       SUBSTR(Padr(Iif(curCltList.CltAddrZIP>0, [, ]+Alltrim(Str(curCltList.CltAddrZIP)), []) + ;
і                       IIF(!Empty(curCltList.CltAddrReg), [, ]+Alltrim(curCltList.CltAddrReg), []) + ;
і                       IIF(!Empty(curCltList.CltAddrStl), [, ]+Alltrim(curCltList.CltAddrStl), []) + ;
і                       IIF(!Empty(curCltList.CltAddrStr), [, ]+Alltrim(curCltList.CltAddrStr), []) + ;
і                       IIF(!Empty(curCltList.CltAddrHs), [, ]+Alltrim(curCltList.CltAddrHs), []) + ;
і                       IIF(!Empty(curCltList.CltAddrRm), [, ]+Alltrim(curCltList.CltAddrRm), []) + ;
і                       IIF(!Empty(curCltList.CltTel), [, ]+Alltrim(curCltList.CltTel), []), 254),3) As CltFullAdr, ;
і                       PADR(Ltrim(Iif(!Empty(curCltList.CltPhPSer), [ серия ]+Alltrim(curCltList.CltPhPSer), []) + ;
і                       IIF(!Empty(curCltList.CltPhPNum), [ номер ]+Alltrim(curCltList.CltPhPNum), []) + ;
і                       IIF(!Empty(curCltList.CltPhPID) Or !Empty(curCltList.CltPhPIB), [ выдан], []) + ;
і                       IIF(!Empty(curCltList.CltPhPIB), [ ]+Alltrim(curCltList.CltPhPIB), []) + ;
і                       IIF(!Empty(curCltList.CltPhPID), [ ]+Dtoc(Ttod(curCltList.CltPhPID)), [])), 254) As CltFullPh, ;
і                       curCltList.CltTypeID, ;
і                       curCltList.CltINN, ;
і                       curCltList.CltFullINN, ;
і                       curCltList.CltAddrZIP, ;
і                       curCltList.CltAddrReg, ;
і                       curCltList.CltAddrStl, ;
і                       curCltList.CltAddrStr, ;
і                       curCltList.CltAddrHs, ;
і                       curCltList.CltAddrRm, ;
і                       curCltList.CltTel, ;
і                       curCltList.CltJrdNM, ;
і                       curCltList.CltJrdKpp, ;
і                       curCltList.CltFullKPP, ;
і                       curCltList.CltLTAbbr, ;
і                       curCltList.CltLTNM, ;
і                       curCltList.CltPhysFNM, ;
і                       curCltList.CltPhysINM, ;
і                       curCltList.CltPhysONM, ;
і                       curCltList.CltFIO, ;
і                       curCltList.CltFIO_, ;
і                       curCltList.CltPhBDate, ;
і                       curCltList.CltPhPSer, ;
і                       curCltList.CltPhPNum, ;
і                       curCltList.CltPhPID, ;
і                       curCltList.CltPhPIB, ;
і                       curCltList.CltPhPDate ;
і                       FROM curCltList ;
і                       INTO Table ([tmp\]+tcCltListTable)
і               *------------------------------------------------------------------------------
і               
і               *16.09.2004 10:40 -> уберем курсоры
і               Use In Iif(Used([curCltList]),[curCltList],0)
і               *------------------------------------------------------------------------------
і               
і               *16.09.2004 15:55 ->Создадим индекс для Relation-а
і               Select (tcCltListTable)
і               Index On cltid Tag cltid Of ([tmp\]+tcCltListTable)
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spClientView()
        * Called by.......: <NA>
        * Parameters......: <tcQryParSID>
        * Returns.........: <lcUniqueFileName>
        * Notes...........: Просмотр клиентов
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spClientView
і               Lparameters tcQryParSID
і               
і               *10.08.2005 14:58 -> Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lcUniqueName, ;
і                       lcUniqueFilePath, ;
і                       lcCltJuridicalExpr, ;
і                       lcCltPhysicalExpr, ;
і                       lcClientExpr, ;
і                       luQryParCltNMEnabled, ;
і                       luQryParCltNM, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult,;
і                       luQryCltIDEnabled ,;
і                       luQryCrdCodEnabled ,;
і                       luQryCltID
і               ***
і               lcOldAlias = Alias()
і               lcUniqueName = [_c] + Sys(2015)
і               lcUniqueFilePath = [tmp\] + lcUniqueName + [.DBF]
і               lcCltJuridicalExpr = []
і               lcCltPhysicalExpr = []
і               lcClientExpr = []
і               *------------------------------------------------------------------------------
і               
і               *10.08.2005 16:48 -> Читаем параметры
і       ЪДДДДДДДIf Pcount()=1 And Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               
і       і               *10.08.2005 16:48 -> Формируем фильтр по наименованию клиента
і       і               luQryParCltNMEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCltNMEnabled])
і       і               *24.09.2007 16:48 -> Формируем фильтр по коду клиента
і       і               luQryCltIDEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCltIDEnabled])
і       і               *24.09.2007 16:48 -> Формируем фильтр по карте клиента
і       і               luQryCrdCodEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCrdCodEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParCltNMEnabled) And Type([luQryParCltNMEnabled])==[L] And luQryParCltNMEnabled
і       і       і               
і       і       і               *10.08.2005 16:49 -> Получим наименование клиента
і       і       і               luQryParCltNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCltNM])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParCltNM) And Type([luQryParCltNM])==[C]
і       і       і       і               
і       і       і       і               *10.08.2005 16:49 -> Формируем фильтры
і       і       і       і               lcCltJuridicalExpr	= [WHERE UPPER(CltJuridical.CltJrdNM) LIKE '%] + Upper(Alltrim(luQryParCltNM)) + [%']
і       і       і       і               lcCltPhysicalExpr	= [WHERE UPPER(LTRIM(CASE WHEN NOT CltPhysical.CltPhysFNM IS NULL AND CltPhysical.CltPhysFNM <> '' THEN ' ' + CltPhysical.CltPhysFNM ELSE '' END + ] + ;
і       і       і       і                       [CASE WHEN NOT CltPhysical.CltPhysINM IS NULL AND CltPhysical.CltPhysINM <> '' THEN ' ' + CltPhysical.CltPhysINM ELSE '' END + ] + ;
і       і       і       і                       [CASE WHEN NOT CltPhysical.CltPhysONM IS NULL AND CltPhysical.CltPhysONM <> '' THEN ' ' + CltPhysical.CltPhysONM ELSE '' END)) ] + ;
і       і       і       і                       [LIKE '%] + Upper(Alltrim(luQryParCltNM)) + [%']
і       і       і       і               lcClientExpr		= [WHERE UPPER(Client.CltNM) LIKE '%] + Upper(Alltrim(luQryParCltNM)) + [%']
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і       ЪДДДДДДДIf !Isnull(luQryCltIDEnabled) And Type([luQryCltIDEnabled])==[L] And luQryCltIDEnabled
і       і       і               *10.08.2005 16:49 -> Получим код клиента
і       і       і               luQryCltID = oQryParMgr.ParamGet(tcQryParSID,[qpnCltID])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryCltID) And Type([luQryCltID])==[C]
і       і       і       і               *10.08.2005 16:49 -> Формируем фильтры
і       і       і       і               lcClientExpr		=  Iif(Empty(Alltrim(lcClientExpr)),[WHERE ],lcClientExpr+' AND ') + [ Client.CltId = ] + Alltrim(luQryCltID)
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і       ЪДДДДДДДIf !Isnull(luQryCrdCodEnabled) And Type([luQryCrdCodEnabled])==[L] And luQryCrdCodEnabled
і       і       і               *10.08.2005 16:49 -> Получим код клиента
і       і       і               luQryCrdCode = oQryParMgr.ParamGet(tcQryParSID,[qpcCrdCode])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryCrdCode) And Type([luQryCrdCode])==[C]
і       і       і       і               *10.08.2005 16:49 -> Формируем фильтры
і       і       і       і               lcClientExpr		=  Iif(Empty(Alltrim(lcClientExpr)),[WHERE ],lcClientExpr+' AND ') + [ Client.CltId IN (SELECT CardOwnerID FROM Card WHERE  CardCode = '] + Alltrim(luQryCrdCode)+[')]
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               lcClientExpr = Iif(Empty(Alltrim(lcClientExpr)),[WHERE 0=1],lcClientExpr)
і               lcCltJuridicalExpr = Iif(Empty(Alltrim(lcCltJuridicalExpr)),[WHERE 0=1],lcCltJuridicalExpr)
і               lcCltPhysicalExpr = Iif(Empty(Alltrim(lcCltPhysicalExpr)),[WHERE 0=1],lcCltPhysicalExpr)
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spClientView ?lcClientExpr, ?lcCltJuridicalExpr, ?lcCltPhysicalExpr],lcUniqueName)
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *11.08.2006 16:04 ->Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.08.2006 16:04 ->Создадим пустой курсор
і       і               Create Cursor (lcUniqueName) ( ;
і       і                       cltid I, CltNM C(1), CltFullNM C(1), CltINN C(1) ;
і       і                       )
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсор в файл и закроем
і               Select (lcUniqueName)
і               ***
і               Copy To (lcUniqueFilePath)
і               ***
і               Use In (lcUniqueName)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.08.2005 16:55 -> Закроем файл
і               Use In Iif(Used(lcUniqueName),lcUniqueName,0)
і               *------------------------------------------------------------------------------
і               
і               *10.08.2005 14:58 -> Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *10.08.2005 14:58 -> Вернем значение
і               Return lcUniqueName
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spCloseCheck()
        * Called by.......: <NA>
        * Parameters......: <tnCheckID>
        * Returns.........: <none>
        * Notes...........: Сброс чека
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spCloseCheck
і               Lparameters tnCheckID
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Сбрасываем чек
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [UPDATE CheckSale ] + ;
і       і                       [SET CheckTypeID = ABS(CheckTypeID)] + ;
і       і                       [WHERE CheckID = ?tnCheckID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               Return .T.
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spCopyAccount()
        * Called by.......: <NA>
        * Parameters......: <tnSrcFrmID,tnTargetFrmTypeID,tcOperation>
        * Returns.........: <lnLastFrmID>
        * Notes...........: Копирование калькуляционной карты
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spCopyAccount
і               Lparameters tnSrcFrmID,tnTargetFrmTypeID,tcOperation
і               
і               *15.12.2004 16:49 ->Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnLastFrmID, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Узнаем тип документа
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spCopyAccount ?tnSrcFrmID, ?tnTargetFrmTypeID, ?tcOperation], ;
і       і                       [curLastFrmID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return 0
і       АДДДДДДДEndif
і               ***
і               lnLastFrmID = curLastFrmID.frmid
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *15.12.2004 16:50 ->Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *16.12.2004 17:58 ->Вернем идентификатор вновь добавленного докумета
і               Return lnLastFrmID
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spCouponReport()
        * Called by.......: <NA>
        * Parameters......: <tnCheckID>
        * Returns.........: <none>
        * Notes...........: Выборка для отчета по талонам
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spCouponReport
і               Lparameters tcQryParSID
і               
і               *02.08.2006 09:30 ->Объявление и инициализация переменных
і               Local	lcOldDate, ;
і                       lcOldCentury, ;
і                       lcOldMark, ;
і                       lcFilterExpr, ;
і                       luQryParDateEnabled, ;
і                       luQryParDateStartDate, ;
і                       luQryParCashEnabled, ;
і                       luQryParCashTableNM, ;
і                       luQryParCashierEnabled, ;
і                       luQryParCashierTableNM, ;
і                       luQryParCltIspEnabled, ;
і                       luQryParIspIDTableNM, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldDate = Set([DATE])
і               lcOldCentury = Set([CENTURY])
і               lcOldMark = Set([MARK])
і               lcFilterExpr = []
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 09:30 ->Создаем таблицу с окружением для отчёта
і               Create Table Tmp\RptEnv Free (QryParSID C(10))
і               Insert Into RptEnv (QryParSID) Values (tcQryParSID)
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 09:30 ->Сформируем условия выбора по дате
і               luQryParDateEnabled   = oQryParMgr.ParamGet(tcQryParSID,[qplDateEnabled])
і               luQryParDateStartDate = oQryParMgr.ParamGet(tcQryParSID,[qpdDateStart])
і               luQryParDateEndDate   = oQryParMgr.ParamGet(tcQryParSID,[qpdDateEnd])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryParDateEnabled)   And Type([luQryParDateEnabled])==[L]   And luQryParDateEnabled And ;
і       і                       !Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate) And ;
і       і                       !Isnull(luQryParDateEndDate)   And Type([luQryParDateEndDate])==[D]   And !Empty(luQryParDateEndDate)
і       і               
і       і               *02.08.2006 09:30 ->Установим формат даты YMD и CENTURY ON
і       і               Set Date YMD
і       і               Set Century On
і       і               Set Mark To "/"
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *02.08.2006 09:31 ->Сформируем условия выбора
і       і               lcFilterExpr = lcFilterExpr + [ AND CheckSale.CheckStamp >= ']+Strtran(Dtoc(luQryParDateStartDate),[/],[])+[' AND CheckSale.CheckStamp < ']+Strtran(Dtoc(luQryParDateEndDate+1),[/],[])+[']
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *02.08.2006 09:31 ->Восстановим старый формат даты
і       і               Set Date (lcOldDate)
і       і               Set Century &lcOldCentury
і       і               Set Mark To lcOldMark
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 09:33 ->Формируем фильтр по кассе
і               luQryParCashEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCashEnabled])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryParCashEnabled) And Type([luQryParCashEnabled])==[L] And luQryParCashEnabled
і       і               luQryParCashTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCashTableNM])
і       і       ЪДДДДДДДIf !Isnull(luQryParCashTableNM) And Type([luQryParCashTableNM])==[C] And File(luQryParCashTableNM+[.dbf])
і       і       і               ***
і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і                       [ AND CheckSale.CheckCashID IN (] + spGetTmpValueList(luQryParCashTableNM) + [)]
і       і       і               
і       і       АДДДДДДДEndif
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 09:34 ->Формируем фильтр по кассе
і               luQryParCashierEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCashierEnabled])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryParCashierEnabled) And Type([luQryParCashierEnabled])==[L] And luQryParCashierEnabled
і       і               luQryParCashierTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCashierTableNM])
і       і       ЪДДДДДДДIf !Isnull(luQryParCashierTableNM) And Type([luQryParCashierTableNM])==[C] And File(luQryParCashierTableNM+[.dbf])
і       і       і               ***
і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і                       [ AND CheckSale.CheckCashierID IN (] + spGetTmpValueList(luQryParCashierTableNM) + [)]
і       і       і               
і       і       АДДДДДДДEndif
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 09:34 ->Формируем фильтр по кассиру
і               luQryParCashierEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCashierEnabled])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryParCashierEnabled) And Type([luQryParCashierEnabled])==[L] And luQryParCashierEnabled
і       і               luQryParCashierTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCashierTableNM])
і       і       ЪДДДДДДДIf !Isnull(luQryParCashierTableNM) And Type([luQryParCashierTableNM])==[C] And File(luQryParCashierTableNM+[.dbf])
і       і       і               ***
і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і                       [ AND CheckSale.CheckCashierID IN (] + spGetTmpValueList(luQryParCashierTableNM) + [)]
і       і       і               
і       і       АДДДДДДДEndif
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 09:47 ->Формируем фильтр по организации
і               luQryParCltIspEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCltIspEnabled])
і               ***
і       ЪДДДДДДДIf !Isnull(luQryParCltIspEnabled) And Type([luQryParCltIspEnabled])==[L] And luQryParCltIspEnabled
і       і               luQryParIspIDTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCltISpIDTableNM])
і       і       ЪДДДДДДДIf !Isnull(luQryParIspIDTableNM) And Type([luQryParIspIDTableNM])==[C] And File(luQryParIspIDTableNM+[.dbf])
і       і       і               ***
і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і                       [ AND Coupon.CltID IN (] + spGetTmpValueList(luQryParIspIDTableNM) + [)]
і       і       і               
і       і       АДДДДДДДEndif
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 09:49 ->Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 09:49 ->Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spCouponReport ?lcFilterExpr],[RptItog])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 09:49 ->Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 09:49 ->Сохраним курсоры на диск и закроем
і               Select RptItog
і               Copy To Tmp\RptItog.Dbf
і               ***
і               Use In Select([RptItog])
і               *------------------------------------------------------------------------------
і               
і               *02.08.2006 10:04 ->Индексируем таблицу
і               Use RptItog In 0 Exclusive
і               Select RptItog
і               Index On OrgNM Tag OrgNM
і               Index On OrgNM + Rtrim(CouponNM) Tag OrgCoupNM
і               ***
і               Use In Select([RptItog])
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spDiscRecount()
        * Called by.......: <NA>
        * Parameters......: <tnFrmID, tnCltID>
        * Returns.........: <none>
        * Notes...........: Пересчет скидки в позициях заказа при смене клиента
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spDiscRecount
і               Lparameters tnFrmID, tnCltID
і               
і               *--Объявление и инициализация переменных
і               Local   lcOldAlias, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *--Коннектимся к БД через существующее соединение
і               Set Database To BASIS
і               ***
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *--Выполняем процедуру смены скидки
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spDiscRecount ?tnFrmID, ?tnCltID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *--Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *--Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias # Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *--Возвращаем результат
і               Return .T.
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFillCorr()
        * Called by.......: <Form Data Request>
        * Parameters......: <tnFrmID>
        * Returns.........: <none>
        * Notes...........: Заполнение корректирующего документа
        *-------------------------------------------------------
ЪДДДДДДДProcedure spFillCorr
і               Lparameters tnFrmID
і               
і               *08.09.2006 11:25 ->Объявление и инициализация переменных
і               Local	lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       llResult
і               *------------------------------------------------------------------------------
і               
і               *08.09.2006 11:25 ->Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *08.09.2006 11:25 ->Заполненяем корректирующий документа
і               lnSqlExeResult = 0
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFillCorr ?tnFrmID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return 0
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *08.09.2006 11:26 ->Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFormCopy()
        * Called by.......: <NA>
        * Parameters......: <tnSrcFrmID,tnTargetFrmTypeID,tcOperation>
        * Returns.........: <lnLastFrmID>
        * Notes...........: Копирование документа
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFormCopy
і               Lparameters tnSrcFrmID,tnTargetFrmTypeID,tcOperation
і               
і               *15.12.2004 16:49 ->Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnLastFrmID, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               Use Tmp\listadd In 0
і       ЪДДДДДДДIf Reccount('listadd') = 0
і       і               Insert Into listadd Values (tnSrcFrmID)
і       ГДДДДДДДElse
і       і       ЪДДДДДДДIf Messagebox('Объединить помеченые записи?' ,4+32+256+4096 ,'Объединение записей' ,200) = 2
і       і       і               Use In listadd
і       і       і               Erase Tmp\listadd.Dbf
і       і       і               Return
і       і       АДДДДДДДEndif
і       АДДДДДДДEndif
і               *** Создаем XML - документ по помеченым записям
і               m.lnCountLine = Cursortoxml("listadd", "lcXML", 1, 0) && так было 16)
і               Use In listadd
і               Erase Tmp\listadd.Dbf
і               
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Узнаем тип документа
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFormCopy  ?lcXML, ?tnTargetFrmTypeID, ?tcOperation], ;
і       і                       [curLastFrmID])
і       і               
і       і               **[EXECUTE spFormCopy  ?tnSrcFrmID, ?tnTargetFrmTypeID, ?tcOperation], ;
і       і               
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               ***
і               lnLastFrmID = curLastFrmID.frmid
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *15.12.2004 16:50 ->Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *16.12.2004 17:58 ->Вернем идентификатор вновь добавленного докумета
і               Return lnLastFrmID
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFormCopyActRule()
        * Called by.......: <NA>
        * Parameters......: <tnSrcFrmID,tnTargetFrmTypeID,tcOperation>
        * Returns.........: <none>
        * Notes...........: Копирование расходной накладной в акт производства
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFormCopyActRule
і               Lparameters tnSrcFrmID,tnTargetFrmTypeID,tcOperation
і               
і               *15.12.2004 16:49 -> Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnLastFrmID, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFormCopyActRule ?tnSrcFrmID, ?tnTargetFrmTypeID, ?tcOperation], ;
і       і                       [curLastFrmID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return 0
і       АДДДДДДДEndif
і               ***
і               lnLastFrmID = curLastFrmID.frmid
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *15.12.2004 16:50 -> Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *16.12.2004 17:58 -> Вернем идентификатор вновь добавленного докумета
і               Return lnLastFrmID
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFormCopyAuto()
        * Called by.......: <NA>
        * Parameters......: <tnSrcFrmID,tnTargetFrmTypeID,tcOperation>
        * Returns.........: <none>
        * Notes...........: Формирует документ с включением в него из источника ;
        * только блюд и модификаторов c последующей обработкой
        * должно быть настроено копирование форм
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFormCopyAuto
і               Lparameters tnSrcFrmID,tnTargetFrmTypeID,tcOperation
і               
і               *15.12.2004 16:49 -> Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       llIsOnlyBludo, ;
і                       lnSrcFrmID, ;
і                       lnLastFrmID, ;
і                       lnHalfReady, ;
і                       lnCounter, ;
і                       lnCirc, ;
і                       laCirc(1)
і               ***
і               llIsOnlyBludo = .T.
і               lnSrcFrmID = tnSrcFrmID
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *19.06.2006 11:20 -> Создаем акт производства с блюдами из текущего документа
і       ЪДДДДДДДDo While .T.
і       і               
і       і               *19.06.2006 11:58 -> Выполняем копирование документа
і       і               lnLastFrmID = spFormCopyBludo(lnSrcFrmID,tnTargetFrmTypeID,tcOperation,llIsOnlyBludo)
і       і               llIsOnlyBludo = .F.
і       і               lnCirc = Alen(laCirc)
і       і               laCirc[lnCirc] = lnLastFrmID
і       і               Dimension laCirc(lnCirc+1)
і       і               lnSrcFrmID = lnLastFrmID
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *19.06.2006 11:58 -> Создаем акт производства
і       і               lnHalfReady = spMakeActPro(lnLastFrmID)
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *19.06.2006 11:25 -> Проверяем на наличие полуфабрикатов, если их нет - выходим
і       і       ЪДДДДДДДIf lnHalfReady = 0
і       і       і               Exit
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEnddo
і               *------------------------------------------------------------------------------
і               
і               *19.06.2006 12:06 -> Переопределяем цены поступления на продукты и на калькуляцию
і       ЪДДДДДДДFor lnCounter = Alen(laCirc) To 1 Step -1
і       і               lnLastFrmID = laCirc[lnCirc]
і       і               spReqActBay(lnLastFrmID,.F.)
і       АДДДДДДДEndfor
і               *------------------------------------------------------------------------------
і               
і               *15.12.2004 16:50 ->Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *19.06.2006 12:12 -> Вывод сообщения
і               Messagebox([Обработка документов завершена],64,[Информация])
і               *------------------------------------------------------------------------------
і               
і               *16.12.2004 17:58 -> Вернем идентификатор вновь добавленного докумета
і               Return lnLastFrmID
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFormCopyBludo()
        * Called by.......: <NA>
        * Parameters......: <tnSrcFrmID,tnTargetFrmTypeID,tcOperation>
        * Returns.........: <none>
        * Notes...........: Формирует документ с включением в него из источника ;
        * только блюд и модификаторов
        * должно быть настроено копирование форм
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFormCopyBludo
і               Lparameters tnSrcFrmID,tnTargetFrmTypeID,tcOperation,tlIsOnlyBludo
і               
і               *15.12.2004 16:49 -> Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnLastFrmID, ;
і                       llIsOnlyBludo, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldAlias = Alias()
і       ЪДДДДДДДIf Pcount() = 3
і       і               llIsOnlyBludo = (Messagebox([Выбирать только полуфабрикаты (без блюд)?],4+32+256, [Вопрос])= 7)
і       ГДДДДДДДElse
і       і               llIsOnlyBludo = tlIsOnlyBludo
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFormCopyBludo ?tnSrcFrmID, ?tnTargetFrmTypeID, ?tcOperation, ?llIsOnlyBludo], ;
і       і                       [curLastFrmID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return 0
і       АДДДДДДДEndif
і               ***
і               lnLastFrmID = curLastFrmID.frmid
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *15.12.2004 16:50 -> Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *16.12.2004 17:58 -> Вернем идентификатор вновь добавленного докумета
і               Return lnLastFrmID
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spFormCopyInventory()
        * Called by.......: <NA>
        * Parameters......: <tnSrcFrmID,tnTargetFrmTypeID,tcOperation>
        * Returns.........: <.T./.F.>
        * Notes...........: Создание сличительной ведомости на основе инвентаризационной
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFormCopyInventory
і               Lparameters tnSrcFrmID,tnTargetFrmTypeID,tcOperation
і               
і               *11.05.2006 17:13 -> Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnLastFrmID, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Узнаем тип документа
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFormCopyInventory ?tnSrcFrmID, ?tnTargetFrmTypeID, ?tcOperation], ;
і       і                       [curLastFrmID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               ***
і               lnLastFrmID = curLastFrmID.frmid
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *11.05.2006 17:13 -> Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *11.05.2006 17:12 -> Вернем идентификатор вновь добавленного докумета
і               Return lnLastFrmID
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spFormCopyScarce()
        * Called by.......: <NA>
        * Parameters......: <tnSrcFrmID,tnTargetFrmTypeID,tcOperation>
        * Returns.........: <.T./.F.>
        * Notes...........: Создание дефицитной ведомости на основе документа
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFormCopyScarce
і               Lparameters tnSrcFrmID,tnTargetFrmTypeID,tcOperation
і               
і               *11.05.2006 17:13 -> Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnLastFrmID, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Узнаем тип документа
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFormCopyScarce ?tnSrcFrmID, ?tnTargetFrmTypeID, ?tcOperation], ;
і       і                       [curLastFrmID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               ***
і               lnLastFrmID = curLastFrmID.frmid
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *11.05.2006 17:13 -> Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *11.05.2006 17:12 -> Вернем идентификатор вновь добавленного докумета
і               Return lnLastFrmID
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spFormJoin()
        * Called by.......: <NA>
        * Parameters......: <tnSrcFrmID,tnTargetFrmTypeID,tcOperation>
        * Returns.........: <.T./.F.>
        * Notes...........: Создание дефицитной ведомости на основе документа
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFormJoin
і               Lparameters tnSrcFrmID,tnTargetFrmTypeID,tcOperation
і               *11.05.2006 17:13 -> Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnLastFrmID, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               Use Tmp\listadd In 0
і       ЪДДДДДДДIf Reccount('listadd') = 0
і       і               Insert Into listadd Values (tnSrcFrmID)
і       ГДДДДДДДElse
і       і       ЪДДДДДДДIf Messagebox('Объединить помеченые записи?' ,4+32+256+4096 ,'Объединение записей' ,2000) = 2
і       і       і               Use In listadd
і       і       і               Erase Tmp\listadd.Dbf
і       і       і               Return
і       і       АДДДДДДДEndif
і       АДДДДДДДEndif
і               *** Создаем XML - документ по помеченым записям
і               m.lnCountLine = Cursortoxml("listadd", "lcXML", 1, 0) && так было 16)
і               Use In listadd
і               Erase Tmp\listadd.Dbf
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Узнаем тип документа
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFormJoin ?lcXML, ?tnTargetFrmTypeID], ;
і       і                       [curLastFrmID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               ***
і               lnLastFrmID = curLastFrmID.frmid
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *11.05.2006 17:13 -> Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *11.05.2006 17:12 -> Вернем идентификатор вновь добавленного докумета
і               Return lnLastFrmID
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFrmAccCardPrint()
        * Called by.......: <When Document Printed>
        * Parameters......: <tnFrmID, tlAddSignature>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати внешних документов содержащих товары
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFrmAccCardPrint
і               Lparameters tcQryParSID
і               
і               *11.05.2005 12:53 -> Объявление и инициализация переменных
і               Local	lnFrmID, ;
і                       llAddSignature, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *11.05.2005 12:54 -> Читаем параметры
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *26.05.2004 21:18 -> Читаем идентификатор документа, который будем печатать
і       і               lnFrmID = oQryParMgr.ParamGet(tcQryParSID,[FrmID])
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.05.2005 12:55 -> Читаем состояние флажка "С печатью/Без печати"
і       і               llAddSignature = oQryParMgr.ParamGet(tcQryParSID,[qplAddSign])
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.F.)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmAccCardPrint ?lnFrmID, ?llAddSignature],[RptItogHD])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:03 -> Получаем вторую результирующую выборку
і               SQLMoreResults(lnConnectHandle,[RptItogDT])
і               SQLMoreResults(lnConnectHandle,[RptItogPrc])
і               SQLMoreResults(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               Select RptItogHD
і               Copy To Tmp\RptItogHD.Dbf
і               ***
і               Select RptItogDT
і               Copy To Tmp\RptItogDT.Dbf
і               ***
і               Select RptItogPrc
і               Copy To Tmp\RptItogPrc.Dbf
і               ***
і               Use In Select([RptItogHD])
і               Use In Select([RptItogDT])
і               Use In Select([RptItogPrc])
і               *------------------------------------------------------------------------------
і               
і               *24.04.2006 13:59 -> Откроем сохраненные на диск таблицы
і               Use Tmp\RptItogHD In 0
і               Use Tmp\RptItogDT In 0
і               Use Tmp\RptItogPrc In 0
і               *------------------------------------------------------------------------------
і               
і               *05.08.2004 15:42 -> Составим список идентификаторов клиентов, упоминающихся в документе
і               Select ;
і                       RptItogHD.cltid As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.OwnCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.DevCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.ExEmiCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.ExIspCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.CntCltID As Id ;
і                       FROM RptItogHD ;
і                       INTO Table Tmp\tmpCltIdList
і               *------------------------------------------------------------------------------
і               
і               *05.08.2004 15:54 ->Получим подробные данные по клиентам
і               spClientInfoExpand([tmpCltIdList],[RptCltInfo])
і               *------------------------------------------------------------------------------
і               
і               *22.07.2004 20:50 -> Вернем список временных файлов, созданных для отчета
і               Return [RPTITOGHD.DBF;RPTITOGDT.DBF;RptCltInfo.dbf;RptCltInfo.cdx;RPTITOGPRC.DBF]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFrmAccCardReport()
        * Called by.......: <When Document Printed>
        * Parameters......: <tcQryParSID>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати калькуляционных карт по актам производства
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFrmAccCardReport
і               Lparameters tcQryParSID
і               
і               *11.05.2005 12:53 -> Объявление и инициализация переменных
і               Local	lnFrmID, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *11.05.2005 12:54 -> Читаем параметры
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *26.05.2004 21:18 -> Читаем идентификатор документа, который будем печатать
і       і               lnFrmID = oQryParMgr.ParamGet(tcQryParSID,[FrmID])
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.F.)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmAccCardReport ?lnFrmID],[RptItogHD])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:03 -> Получаем вторую результирующую выборку
і               lnSqlExeResult = SQLMoreResults(lnConnectHandle,[RptItogDT])
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               SQLMoreResults(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               Select RptItogHD
і               Copy To Tmp\RptItogHD.Dbf
і               ***
і               Select RptItogDT
і               Copy To Tmp\RptItogDT.Dbf
і               ***
і               Use In Select([RptItogHD])
і               Use In Select([RptItogDT])
і               
і               *24.04.2006 13:59 -> Откроем сохраненные на диск таблицы
і               Use Tmp\RptItogHD In 0 Exclusive
і               Use Tmp\RptItogDT In 0 Exclusive
і               *------------------------------------------------------------------------------
і               
і               *04.09.2006 11:44 -> Создадим индекс для Relation-а
і               Select RptItogHD
і               Index On frmid Tag frmid Of Tmp\RptItogHD
і               *------------------------------------------------------------------------------
і               
і               *05.08.2004 15:42 -> Составим список идентификаторов клиентов, упоминающихся в документе
і               Select ;
і                       RptItogHD.OwnCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.DevCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.ExIspCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.CntCltID As Id ;
і                       FROM RptItogHD ;
і                       INTO Table Tmp\tmpCltIdList
і               *------------------------------------------------------------------------------
і               
і               *05.08.2004 15:54 ->Получим подробные данные по клиентам
і               spClientInfoExpand([tmpCltIdList],[RptCltInfo])
і               *------------------------------------------------------------------------------
і               
і               *22.07.2004 20:50 -> Вернем список временных файлов, созданных для отчета
і               Return [RPTITOGHD.DBF;RPTITOGHD.CDX;RPTITOGDT.DBF;RptCltInfo.dbf;RptCltInfo.cdx]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures For Basis
        * Module/Procedure: spFrmAutoNum()
        * Called by.......: <NA>
        * Parameters......: <tnFrmTypeID,tnPointEmiOUID,tnPointIspOUID,tdDate>
        * Returns.........: <lcFrmNum>
        * Notes...........: Автонумератор
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFrmAutoNum
і               Lparameters tnFrmTypeID,tdDate,tnPointEmiOUID,tnPointIspOUID,tnFrmID
і       ЪДДДДДДДIf Pcount()<5
і       і               tnFrmID = 0
і       АДДДДДДДEndif
і               *21.12.2004 18:09 ->Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       lnOUID, ;
і                       lnOwnCltID, ;
і                       lcMask, ;
і                       lcFrmNum, ;
і                       lnStartPos, ;
і                       lnEndPos, ;
і                       lcSerialSection, ;
і                       lcSerialSectionValue, ;
і                       lnCounter
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Узнаем тип документа
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [SELECT ] + ;
і       і                       [FrmType.FrmTypeDirection ] + ;
і       і                       [FROM FrmType ] + ;
і       і                       [WHERE FrmType.FrmTypeID = ?tnFrmTypeID], ;
і       і                       [curFrmType])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return [б\н]
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *21.12.2004 18:08 ->Вычисляем код подразделения
і               lnOUID = Iif(curFrmType.FrmTypeDirection=2,tnPointIspOUID,tnPointEmiOUID)
і               ***
і       ЪДДДДДДДIf lnOUID = 0
і       і               Return [б\н]
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *22.12.2004 10:06 -> Закрываем курсор curFrmType
і               Use In Select([curFrmType])
і               *------------------------------------------------------------------------------
і               
і               *21.12.2004 18:18 ->Вычисляем идентификатор родителя подразделения
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [SELECT ] + ;
і       і                       [OrgUnit.CltID ] + ;
і       і                       [FROM OrgUnit ] + ;
і       і                       [WHERE OrgUnit.OUID = ?lnOUID], ;
і       і                       [curOrgUnit])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return [б\н]
і       АДДДДДДДEndif
і               ***
і               lnOwnCltID = curOrgUnit.cltid
і               ***
і       ЪДДДДДДДIf Empty(lnOwnCltID)
і       і               *ASSERT .F. MESSAGE [STORED PROCEDURES FOR BASIS: невозможно сгенерировать номер по подразделению, не имеющему родителя-клиента]
і       і               Return [б\н]
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *22.12.2004 10:06 -> Закрываем курсор curOrgUnit
і               Use In Select([curOrgUnit])
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Получим параметры автонумерации
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmAutoNum ?tnFrmTypeID, ?lnOUID], ;
і       і                       [curFrmTypeAutoNum])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return [б\н]
і       АДДДДДДДEndif
і               ***
і       ЪДДДДДДДIf Reccount([curFrmTypeAutoNum])#1
і       і               Messagebox('Нумерацию этого типа документа необходимо настроить...',0+64,'Обратитесь к администратору',5000)
і       і               **ASSERT .F. MESSAGE [STORED PROCEDURES FOR BASIS: не найден параметр автонумератора для данного типа документа]
і       і               **RETURN [ERROR]
і       і               Return [б\н]
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *21.12.2004 18:23 ->Генерируем счётчик
і               lcFrmNum = []
і               ***
і       ЪДДДДДДДIf !Empty(curFrmTypeAutoNum.AutoNumMask) And curFrmTypeAutoNum.AutoNumIsEnabled
і       і               lcFrmNum = Alltrim(curFrmTypeAutoNum.AutoNumMask)
і       і       ЪДДДДДДДDo While [{]$lcFrmNum And [}]$lcFrmNum
і       і       і               lnStartPos = At([{],lcFrmNum)
і       і       і               lnEndPos = At([}],lcFrmNum)
і       і       і               ***
і       і       і       ЪДДДДДДДIf lnStartPos > lnEndPos
і       і       і       і               Messagebox('Нумерацию этого типа документа необходимо настроить...',0+64,'Обратитесь к администратору',5000)
і       і       і       і               *ASSERT .F. MESSAGE [STORED PROCEDURES FOR BASIS: некорректная маска автонумератора]
і       і       і       і               *RETURN [ERROR]
і       і       і       і               Return [б\н]
і       і       і       АДДДДДДДEndif
і       і       і               ***
і       і       і               lcSerialSection = Substr(lcFrmNum,lnStartPos+1,lnEndPos-lnStartPos-1)
і       і       і               ***
і       і       і       ЪДДДДДДДDo Case
і       і       і       ГДДДДДДДCase Upper(lcSerialSection)==[NFRMIF]
і       і       і       і               lcSerialSectionValue = Alltrim(Str(tnFrmID,10,0))
і       і       і       ГДДДДДДДCase Upper(lcSerialSection)==[YYYY]
і       і       і       і               lcSerialSectionValue = Alltrim(Str(Year(tdDate)))
і       і       і       ГДДДДДДДCase Upper(lcSerialSection)==[YY]
і       і       і       і               lcSerialSectionValue = Right(Alltrim(Str(Year(tdDate))),2)
і       і       і       ГДДДДДДДCase Upper(lcSerialSection)==[MM]
і       і       і       і               lcSerialSectionValue = Alltrim(Str(Month(tdDate)))
і       і       і       ГДДДДДДДCase Upper(lcSerialSection)==[DD]
і       і       і       і               lcSerialSectionValue = Alltrim(Str(Day(tdDate)))
і       і       і       ГДДДДДДДCase [n]$lcSerialSection Or [N]$lcSerialSection
і       і       і       і               lnCounter = spFrmAutoNumGetCounter(Iif(curFrmTypeAutoNum.FrmTypeIDIsConst,curFrmTypeAutoNum.FrmTypeIDConst,tnFrmTypeID), ;
і       і       і       і                       IIF(curFrmTypeAutoNum.OwnCltIDIsConst,curFrmTypeAutoNum.OwnCltIDConst,lnOwnCltID), ;
і       і       і       і                       IIF(curFrmTypeAutoNum.OUIDIsConst,curFrmTypeAutoNum.OUIDConst,lnOUID))
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf [N]$lcSerialSection
і       і       і       і       і               lcSerialSectionValue = Padl(Alltrim(Str(lnCounter)),lnEndPos-lnStartPos-1,[0])
і       і       і       і       ГДДДДДДДElse
і       і       і       і       і               lcSerialSectionValue = Alltrim(Str(lnCounter))
і       і       і       і       АДДДДДДДEndif
і       і       і       ГДДДДДДДOtherwise
і       і       і       і               lcSerialSectionValue = []
і       і       і       АДДДДДДДEndcase
і       і       і               ***
і       і       і               lcFrmNum = Stuff(lcFrmNum,lnStartPos,lnEndPos-lnStartPos+1,lcSerialSectionValue)
і       і       АДДДДДДДEnddo
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *22.12.2004 10:07 -> Закрываем таблицы
і               Use In Iif(Used([curFrmTypeAutoNum]),[curFrmTypeAutoNum],0)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *23.12.2004 12:06 ->Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *21.12.2004 19:01 ->Вернём сгенерированный номер
і               Return lcFrmNum
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFrmAutoNumGetCounter()
        * Called by.......: spFrmAutoNum()
        * Parameters......: <tnFrmTypeID,tnOwnCltID,tnOUID>
        * Returns.........: <lnCounter>
        * Notes...........: Возвращаем счетчик автонумератора
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFrmAutoNumGetCounter
і               Lparameters tnFrmTypeID,tnOwnCltID,tnOUID
і               
і               *27.06.2006 15:17 -> Объявление и инициализация переменных
і               Local 	lcOldAlias, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       lnLastID, ;
і                       lnCounter
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Получим параметры автонумерации
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmAutoNumGetCounter ?tnFrmTypeID, ?tnOwnCltID, ?tnOUID], ;
і       і                       [curFrmNumCounter])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return 0
і       АДДДДДДДEndif
і               ***
і               lnCounter = curFrmNumCounter.FrmNumCntVal
і               ***
і               Use In Select([curFrmNumCounter])
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *23.12.2004 12:14 ->Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *22.12.2004 12:15 -> Возвращаем значение счетчика
і               Return lnCounter
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: SPFRMEXTERNALPARTFRMPRINT()
        * Called by.......: <When Document Printed>
        * Parameters......: <tnFrmID, tlAddSignature>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати внешних документов содержащих документы (суммы)
        *-------------------------------------------------------
ЪДДДДДДДProcedure spFrmExternalPartFrmPrint
і               Lparameters tcQryParSID
і               
і               *11.05.2005 12:53 ->Объявление и инициализация переменных
і               Local	lnFrmID, ;
і                       llAddSignature, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *11.05.2005 12:54 ->Читаем параметры
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *26.05.2004 21:18 ->Читаем идентификатор документа, который будем печатать
і       і               lnFrmID = oQryParMgr.ParamGet(tcQryParSID,[FrmID])
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.05.2005 12:55 ->Читаем состояние флажка "С печатью/Без печати"
і       і               llAddSignature = oQryParMgr.ParamGet(tcQryParSID,[qplAddSign])
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.F.)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmExternalPartFrmPrint ?lnFrmID, ?llAddSignature],[RptItogHD])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:03 -> Получаем вторую результирующую выборку
і               SQLMoreResults(lnConnectHandle,[RptItogDT])
і               SQLMoreResults(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               Select RptItogHD
і               Copy To Tmp\RptItogHD.Dbf
і               ***
і               Select RptItogDT
і               Copy To Tmp\RptItogDT.Dbf
і               ***
і               Use In Select([RptItogHD])
і               Use In Select([RptItogDT])
і               *------------------------------------------------------------------------------
і               
і               *24.04.2006 13:59 -> Откроем сохраненные на диск таблицы
і               Use Tmp\RptItogHD In 0
і               Use Tmp\RptItogDT In 0
і               *------------------------------------------------------------------------------
і               
і               *05.08.2004 15:42 ->Составим список идентификаторов клиентов, упоминающихся в документе
і               Select ;
і                       RptItogHD.cltid As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.OwnCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.DevCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.ExEmiCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.ExIspCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.CntCltID As Id ;
і                       FROM RptItogHD ;
і                       INTO Cursor curCltIdList
і               *------------------------------------------------------------------------------
і               
і               *21.04.2006 17:34 -> Получим подробные данные по клиентам
і               spClientInfoExpand([curCltIdList],[RptCltInfo])
і               *------------------------------------------------------------------------------
і               
і               *23.09.2004 17:24 ->Составим список идентификаторов расчётных счетов клиентов
і               Select ;
і                       RptItogHD.CltSAccID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.OwnSAccID As Id ;
і                       FROM RptItogHD ;
і                       INTO Cursor curSAccIdList
і               *------------------------------------------------------------------------------
і               
і               *21.04.2006 17:34 -> Получим подробные данные по расчётным счетам
і               spSAccInfoExpand([curSAccIdList],[RptSAccInfo])
і               *------------------------------------------------------------------------------
і               
і               *22.07.2004 20:50 -> Вернем список временных файлов, созданных для отчета
і               Return [RptItogHD.dbf;RptItogDT.DBF;RptCltInfo.dbf;RptCltInfo.cdx;RptSAccInfo.dbf;RptSAccInfo.cdx]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFrmExternalPartFrmPrintDetail()
        * Called by.......: <When Document Printed>
        * Parameters......: <tnFrmID, tlAddSignature>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати документов содержащих данные в таблице FrmPayDetail
        *-------------------------------------------------------
ЪДДДДДДДProcedure spFrmExternalPartFrmPrintDetail
і               Lparameters tcQryParSID
і               
і               *11.05.2005 12:53 ->Объявление и инициализация переменных
і               Local	lcResult, ;
і                       lnFrmID, ;
і                       llAddSignature, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *12.01.2005 10:35 -> Вызываем процедуру выборки формирующую данные без FrmPayDetail
і               lcResult = spFrmExternalPartFrmPrint(tcQryParSID)
і               *------------------------------------------------------------------------------
і               
і               *11.05.2005 12:54 ->Читаем параметры
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *26.05.2004 21:18 ->Читаем идентификатор документа, который будем печатать
і       і               lnFrmID = oQryParMgr.ParamGet(tcQryParSID,[FrmID])
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.05.2005 12:55 ->Читаем состояние флажка "С печатью/Без печати"
і       і               llAddSignature = oQryParMgr.ParamGet(tcQryParSID,[qplAddSign])
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmExternalPartFrmPrintDetail ?lnFrmID],[RptItogPD])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсор на диск и закроем
і               Select RptItogPD
і               Copy To Tmp\RptItogPD.Dbf
і               ***
і               Use In Select([RptItogPD])
і               *------------------------------------------------------------------------------
і               
і               *24.04.2006 13:59 -> Откроем сохраненную на диск таблицу
і               Use Tmp\RptItogPD In 0
і               *------------------------------------------------------------------------------
і               
і               *12.01.2005 10:48 -> Вернем список временных файлов, созданных для отчета
і               Return lcResult + [;RPTITOGPD.DBF]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFrmExternalPartTvrPrint()
        * Called by.......: <When Document Printed>
        * Parameters......: <tnFrmID, tlAddSignature>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати внешних документов содержащих товары
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFrmExternalPartTvrPrint
і               Lparameters tcQryParSID
і               
і               *11.05.2005 12:53 -> Объявление и инициализация переменных
і               Local	lnFrmID, ;
і                       llAddSignature, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *11.05.2005 12:54 ->Читаем параметры
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *26.05.2004 21:18 ->Читаем идентификатор документа, который будем печатать
і       і               lnFrmID = oQryParMgr.ParamGet(tcQryParSID,[FrmID])
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.05.2005 12:55 ->Читаем состояние флажка "С печатью/Без печати"
і       і               llAddSignature = oQryParMgr.ParamGet(tcQryParSID,[qplAddSign])
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.F.)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmExternalPartTvrPrint ?lnFrmID, ?llAddSignature],[RptItogHD])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:03 -> Получаем вторую результирующую выборку
і               SQLMoreResults(lnConnectHandle,[RptItogDT])
і               SQLMoreResults(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               Select RptItogHD
і               Copy To Tmp\RptItogHD.Dbf
і               ***
і               Select RptItogDT
і               Copy To Tmp\RptItogDT.Dbf
і               ***
і               Use In Select([RptItogHD])
і               Use In Select([RptItogDT])
і               *------------------------------------------------------------------------------
і               
і               *24.04.2006 13:59 -> Откроем сохраненные на диск таблицы
і               Use Tmp\RptItogHD In 0 Exclusive
і               Use Tmp\RptItogDT In 0 Exclusive
і               ***
і               Select RptItogDT
і               Index On TvrNm Tag TvrNm
і               Set Order To
і               *------------------------------------------------------------------------------
і               
і               *05.08.2004 15:42 -> Составим список идентификаторов клиентов, упоминающихся в документе
і               Select ;
і                       RptItogHD.cltid As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.OwnCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.DevCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.ExEmiCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.ExIspCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.CntCltID As Id ;
і                       FROM RptItogHD ;
і                       INTO Cursor curCltIdList
і               *------------------------------------------------------------------------------
і               
і               *21.04.2006 17:34 -> Получим подробные данные по клиентам
і               spClientInfoExpand([curCltIdList],[RptCltInfo])
і               *------------------------------------------------------------------------------
і               
і               *23.09.2004 17:24 -> Составим список идентификаторов расчётных счетов клиентов
і               Select ;
і                       RptItogHD.CltSAccID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.OwnSAccID As Id ;
і                       FROM RptItogHD ;
і                       INTO Cursor curSAccIdList
і               *------------------------------------------------------------------------------
і               
і               *21.04.2006 17:34 -> Получим подробные данные по расчётным счетам
і               spSAccInfoExpand([curSAccIdList],[RptSAccInfo])
і               *------------------------------------------------------------------------------
і               
і               *22.07.2004 20:50 -> Вернем список временных файлов, созданных для отчета
і               Return [RptItogHD.dbf;RptItogDT.DBF;RptCltInfo.dbf;RptCltInfo.cdx;RptSAccInfo.dbf;RptSAccInfo.cdx]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFrmInternalPartTvrPrint()
        * Called by.......: <When Document Printed>
        * Parameters......: <tcQryParSID>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати внутренних документов содержащих товары
        *-------------------------------------------------------
ЪДДДДДДДProcedure spFrmInternalPartTvrPrint
і               Lparameters tcQryParSID
і               
і               *11.05.2005 12:53 ->Объявление и инициализация переменных
і               Local	lnFrmID, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *11.05.2005 12:54 ->Читаем параметры
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *26.05.2004 21:18 ->Читаем идентификатор документа, который будем печатать
і       і               lnFrmID = oQryParMgr.ParamGet(tcQryParSID,[FrmID])
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.F.)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmInternalPartTvrPrint ?lnFrmID],[RptItogHD])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:03 -> Получаем вторую результирующую выборку
і               SQLMoreResults(lnConnectHandle,[RptItogDT])
і               SQLMoreResults(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               Select RptItogHD
і               Copy To Tmp\RptItogHD.Dbf
і               ***
і               Select RptItogDT
і               Copy To Tmp\RptItogDT.Dbf
і               ***
і               Use In Select([RptItogHD])
і               Use In Select([RptItogDT])
і               *------------------------------------------------------------------------------
і               
і               *24.04.2006 13:59 -> Откроем сохраненные на диск таблицы
і               Use Tmp\RptItogHD In 0 Exclusive
і               Use Tmp\RptItogDT In 0 Exclusive
і               *------------------------------------------------------------------------------
і               
і               *05.08.2004 15:42 -> Составим список идентификаторов клиентов, упоминающихся в документе
і               Select ;
і                       RptItogHD.OwnCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.DevCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.ExEmiCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.ExIspCltID As Id ;
і                       FROM RptItogHD ;
і                       UNION ;
і                       SELECT ;
і                       RptItogHD.CntCltID As Id ;
і                       FROM RptItogHD ;
і                       INTO Cursor curCltIdList
і               *------------------------------------------------------------------------------
і               
і               *05.08.2004 15:54 -> Получим подробные данные по клиентам
і               spClientInfoExpand([curCltIdList],[RptCltInfo])
і               *------------------------------------------------------------------------------
і               
і               *26.05.2006 10:41 -> Создаем индексы
і               Select RptItogDT
і               Index On Str(TvrCalc,10) + Iif(TvrQnt>0,[1],[2]) Tag TvrCalc Compact
і               Index On Str(Nvl(MenuRate,0),10,3)+ Alltrim(TvrNm) Tag TvrMenu Compact
і               Index On Alltrim(TvrNm) Tag TvrNm Compact
і               Set Order To
і               *INDEX ON STR(TvrCalc,10) + STR(tvridcalc,10) + IIF(TvrQnt>0,[1],[2]) TAG TvrCalc COMPACT
і               *------------------------------------------------------------------------------
і               
і               *22.07.2004 20:50 ->Вернем список временных файлов, созданных для отчета
і               Return [RPTITOGHD.DBF;RPTITOGDT.DBF;RptCltInfo.dbf;RptCltInfo.cdx]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored procedures for Basis
        * Module/Procedure: spFrmInventoryPrint()
        * Called by.......: <NA>
        * Parameters......: <tcQryParSID>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для отчета "Инвентаризационная ведомость"
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spFrmInventoryPrint
і               Lparameters tcQryParSID
і               
і               *12.05.2006 11:02 -> Объявление и инициализация переменных
і               Local	lnFrmID, ;
і                       lcOldAlias, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *12.05.2006 11:02 -> Создаем таблицу с окружением для отчёта
і               Create Table Tmp\RptEnv Free (QryParSID C(10))
і               Insert Into RptEnv (QryParSID) Values (tcQryParSID)
і               *------------------------------------------------------------------------------
і               
і               *12.05.2006 11:02 ->Читаем параметры
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *12.05.2006 11:02 -> Читаем идентификатор документа, который будем печатать
і       і               lnFrmID = oQryParMgr.ParamGet(tcQryParSID,[FrmID])
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.F.)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmInventoryPrint ?lnFrmID],[RptItogHD])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:03 -> Получаем вторую результирующую выборку
і               SQLMoreResults(lnConnectHandle,[InvTotal])
і               SQLMoreResults(lnConnectHandle,[RptItogDT])
і               SQLMoreResults(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               Select RptItogHD
і               Copy To Tmp\RptItogHD.Dbf
і               ***
і               Select InvTotal
і               Copy To Tmp\InvTotal.Dbf
і               ***
і               Select RptItogDT
і               Copy To Tmp\RptItogDT.Dbf
і               ***
і               Use In Select([RptItogHD])
і               Use In Select([InvTotal])
і               Use In Select([RptItogDT])
і               *------------------------------------------------------------------------------
і               
і               *30.06.2006 13:25 -> Убираем повторяющеися значения
і               *------------------------------------------------------------------------------
і               
і               *12.05.2006 11:29 -> Закроем таьлицы
і               Use In Select([RptEnv])
і               Use In Select([RptItogDT])
і               *------------------------------------------------------------------------------
і               
і               *12.05.2006 11:29 -> Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *12.05.2006 11:29 -> Вернем список временных таблиц для построения отчета
і               Return [RptItogHD.dbf;RptItogDT.dbf;InvTotal.dbf;RptEnv.dbf]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFrmPartFrmView()
        * Called by.......: <NA>
        * Parameters......: <tcExecVar[,tuFrmID[,tuFrmPartFrmID]]>
        *					<[NODATA]>
        *					<[BYFRMID],tnFrmID>
        *					<[BYFRMPARTFRMID],tnFrmID,tnFrmPartFrmID>
        * Returns.........: <lcUniqueFileName>
        * Notes...........: Получение данных для просмотра суммовых позиций документа
        *-------------------------------------------------------
ЪДДДДДДДProcedure spFrmPartFrmView
і               Lparameters tcExecVar,tuFrmID,tuFrmPartFrmID
і               
і               *21.04.2004 12:31 ->Объявление и инициализация переменных
і               Local	lcUniqueName, ;
і                       lcUniqueFilePath, ;
і                       lcFilterExpr, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcUniqueName = [_d] + Sys(2015)
і               lcUniqueFilePath = [tmp\] + lcUniqueName + [.DBF]
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 12:33 ->Формируем фильтры в зависимости от типа запроса
і       ЪДДДДДДДDo Case
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[NODATA]
і       і               
і       і               *21.04.2004 12:34 ->Формируем фильтр, для формирования пустой выборки
і       і               lcFilterExpr = [WHERE 0=1]
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[BYFRMID]
і       і               
і       і               *21.04.2004 12:32 ->Формируем фильтр для выбора суммовых позиций одного документа
і       і               lcFilterExpr = [WHERE FrmPartFrm.FrmID = ]+Alltrim(Str(tuFrmID))
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[BYFRMPARTFRMID]
і       і               
і       і               *21.04.2004 12:32 ->Формируем фильтр для выбора суммовых позиций одного документа
і       і               lcFilterExpr = 	[WHERE FrmPartFrm.FrmID = ] + Alltrim(Str(tuFrmID)) + [ ] + ;
і       і                       [AND FrmPartFrm.FrmPartFrmID = ] + Alltrim(Str(tuFrmPartFrmID))
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndcase
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED ] + ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmPartFrmView ?lcFilterExpr],lcUniqueName)
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *11.08.2006 15:29 ->Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.08.2006 15:30 ->Создадим пустой курсор
і       і               Create Cursor (lcUniqueName) ( ;
і       і                       PartFrmID I, CntFrmNM C(1), CntFrmSum I, CntFrmVAT I, CntFrmId I, FrmNote C(100) ;
і       і                       )
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсор в файл и закроем
і               Select (lcUniqueName)
і               ***
і               Copy To (lcUniqueFilePath)
і               ***
і               Use In Select(lcUniqueName)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 14:27 ->Вернем значение
і               Return lcUniqueName
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFrmPartTvrView()
        * Called by.......: <NA>
        * Parameters......: <tcExecVar[,tuFrmID[,tnFrmPartFrmID]]>
        *					<[NODATA]>
        *					<[BYFRMID],tnFrmID>
        *					<[BYFRMPARTTVRID],tnFrmID,tnFrmPartTvrID>
        * Returns.........: <lcUniqueFileName>
        * Notes...........: Получение данных для просмотра товарных позиций документа
        *-------------------------------------------------------
ЪДДДДДДДProcedure spFrmPartTvrView
і               Lparameters tcExecVar,tuFrmID,tuFrmPartTvrID
і               
і               *21.04.2004 12:31 ->Объявление и инициализация переменных
і               Local	lcUniqueName, ;
і                       lcUniqueFilePath, ;
і                       lcFilterExpr, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcUniqueName = [_d] + Sys(2015)
і               lcUniqueFilePath = [tmp\] + lcUniqueName + [.DBF]
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 12:33 ->Формируем фильтры в зависимости типы запроса
і       ЪДДДДДДДDo Case
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[NODATA]
і       і               
і       і               *21.04.2004 12:34 ->Формируем фильтр, для формирования пустой выборки
і       і               lcFilterExpr = [WHERE 0=1]
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[BYFRMID]
і       і               
і       і               *21.04.2004 12:32 ->Формируем фильтр для выбора товарных позиций одного документа
і       і               lcFilterExpr = [WHERE  FrmID = ]+Alltrim(Str(tuFrmID))
і       і               *		lcFilterExpr = [WHERE FrmPartTvr.FrmID = ]+ALLTRIM(STR(tuFrmID))
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[BYFRMPARTTVRID]
і       і               
і       і               *21.04.2004 12:32 ->Формируем фильтр для выбора суммовых позиций одного документа
і       і               lcFilterExpr = 	[WHERE  FrmID = ] + Alltrim(Str(tuFrmID)) + ;
і       і                       [AND  PartTvrID = ] + Alltrim(Str(tuFrmPartTvrID))
і       і               *						[AND  FrmPartTvrID = ] + ALLTRIM(STR(tuFrmPartTvrID))
і       і               *		lcFilterExpr = 	[WHERE FrmPartTvr.FrmID = ] + ALLTRIM(STR(tuFrmID)) + ;
і       і               *						[AND FrmPartTvr.FrmPartTvrID = ] + ALLTRIM(STR(tuFrmPartTvrID))
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndcase
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spFrmPartTvrView ?lcFilterExpr],lcUniqueName)
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *11.08.2006 15:37 ->Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.08.2006 15:30 ->Создадим пустой курсор
і       і               Create Cursor (lcUniqueName) ( ;
і       і                       PartTvrID I, TvrTypeID I, TvrIdCalc I, TvrID I, TvrNm C(1), TvrQnt I, TvrQntNett I, ;
і       і                       MsuShortNM C(1), TvrPrcBuy I, TvrSumBuy I, TvrPrcSale I, TvrSumSale I, MsuID I, frmid I, DiscPerc I , DeltaSumm I, DeltaPrc I ;
і       і                       )
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсор в файл и закроем
і               Select (lcUniqueName)
і               ***
і               Copy To (lcUniqueFilePath)
і               ***
і               Use In Select(lcUniqueName)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 14:27 ->Вернем значение
і               Return lcUniqueName
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spFrmPrBookView()
        * Called by.......: <NA>
        * Parameters......: <tcExecVar[,tuFrmID[,tnFrmPartFrmID]]>
        *					<[NODATA]>
        *					<[BYFRMID],tnFrmID>
        *					<[BYFRMPARTTVRID],tnFrmID,tnFrmPartID>
        * Returns.........: <lcUniqueFileName>
        * Notes...........: Получение данных для просмотра проводок соответствующих документу
        *-------------------------------------------------------
ЪДДДДДДДProcedure spFrmPrBookView
і               Lparameters tcExecVar,tuFrmID,tuFrmPartID
і               
і               *05.08.2006 12:31 ->Объявление и инициализация переменных
і               Local	lcUniqueName, ;
і                       lcUniqueFilePath, ;
і                       lcFilterExpr, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcUniqueName = [_d] + Sys(2015)
і               lcUniqueFilePath = [tmp\] + lcUniqueName + [.DBF]
і               *------------------------------------------------------------------------------
і               *05.08.2006 12:33 ->Формируем фильтры в зависимости типы запроса
і       ЪДДДДДДДDo Case
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[NODATA]
і       і               
і       і               *05.08.2006 12:34 ->Формируем фильтр, для формирования пустой выборки
і       і               lcFilterExpr = [WHERE 0=1]
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[BYFRMID]
і       і               
і       і               *05.08.2006 12:32 ->Формируем фильтр для выбора товарных позиций одного документа
і       і               lcFilterExpr = [WHERE FrmPrBookView.PBookFrmID = ]+Alltrim(Str(tuFrmID))
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[BYFRMPARTID]
і       і               
і       і               *05.08.2006 12:32 ->Формируем фильтр для выбора суммовых позиций одного документа
і       і               lcFilterExpr = 	[WHERE FrmPrBookView.PBookID = ] + Alltrim(Str(tuFrmPartID))
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndcase
і               *------------------------------------------------------------------------------
і               
і               *05.08.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *05.08.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [ SELECT * FROM FrmPrBookView ] + lcFilterExpr ,lcUniqueName)
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               *11.08.2006 15:37 ->Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.08.2006 15:30 ->Создадим пустой курсор
і       і               Create Cursor (lcUniqueName) ( ;
і       і                       PBookID I, PBookFrmId I, PBookSum Y, Debet I, Credit I, PBookProvID I, DebetID I, CreditID I, FrmPartId I ,PBookNote C(40);
і       і                       )
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *05.08.2006 14:07 -> Сохраним курсор в файл и закроем
і               Select (lcUniqueName)
і               ***
і               Copy To (lcUniqueFilePath)
і               ***
і               Use In Select(lcUniqueName)
і               *------------------------------------------------------------------------------
і               
і               *05.08.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *05.08.2006 14:27 ->Вернем значение
і               Return lcUniqueName
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spGetAccNetto()
        * Called by.......: <NA>
        * Parameters......: <tnFrmID>
        * Returns.........: <none>
        * Notes...........: Определяем нетто и себестоимость для всего блюда
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetAccNetto
і               Lparameters tnFrmID
і               
і               *09.06.2006 16:20 -> Объявление и инициализация переменных
і               Local	lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [UPDATE Accounting SET ] + ;
і       і                       [AccPrice = AccExit.Price, ] + ;
і       і                       [AccNetto = AccExit.Netto ] + ;
і       і                       [FROM ( ] + ;
і       і                       [SELECT ] + ;
і       і                       [SUM(FrmPartTvr.TvrQnt*FrmPartTvr.TvrPrcBuy) AS Price, ] + ;
і       і                       [SUM(FrmPartTvr.TvrQntNetto) AS Netto ] + ;
і       і                       [FROM FrmPartTvr ] + ;
і       і                       [INNER JOIN Tovar ON Tovar.TvrID = FrmPartTvr.TvrID ] + ;
і       і                       [WHERE FrmPartTvr.FrmID = ?tnFrmID AND Tovar.TvrTypeID <> 6) AS AccExit ] + ;
і       і                       [WHERE Accounting.AccFrmID = ?tnFrmID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return 0
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spGetBaseMsuList()
        * Called by.......: <NA>
        * Parameters......: <tnMsuID>
        * Returns.........: <none>
        * Notes...........:
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetBaseMsuList
і               Lparameters tnMsuID
і               
і               *11.01.2006 15:42 -> Объявление и инициализация переменных
і               Local   lcDependentName, ;
і                       lcIndependentName, ;
і                       lcDependentFilePath, ;
і                       lcIndependentFilePath, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcDependentName   = [_sp]+Sys(2015)
і               lcIndependentName = [_sp]+Sys(2015)
і               lcDependentFilePath   = [tmp\] + lcDependentName + [.dbf]
і               lcIndependentFilePath = [tmp\] + lcIndependentName + [.dbf]
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.F.)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spGetBaseMsuList ?tnMsuID],lcDependentName)
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:03 -> Получаем вторую результирующую выборку
і               SQLMoreResults(lnConnectHandle,lcIndependentName)
і               SQLMoreResults(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               Select (lcDependentName)
і               Copy To (lcDependentFilePath)
і               ***
і               Select (lcIndependentName)
і               Copy To (lcIndependentFilePath)
і               ***
і               Use In Select(lcDependentName)
і               Use In Select(lcIndependentName)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 14:27 -> Вернем имена таблиц
і               Return lcIndependentName+[;]+lcDependentName
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spRentaStat()
        * Called by.......: <When Document Printed>
        * Parameters......: <tcQryParSID>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для печати отчёта по продажам оборудования в прокат
        *-----------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetCardInfo
і               Lparameters lnCardId
і               
і               *21.04.2004 12:31 -> Объявление и инициализация переменных
і               Local	lcValueList, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult,;
і                       wkdate
і               ***
і               lcOldDate = Set([DATE])
і               lcOldCentury = Set([CENTURY])
і               lcOldMark = Set([MARK])
і               
і               
і               
і               *21.04.2006 10:33 -> Установим формат даты YMD и CENTURY ON
і               Set Date YMD
і               ***
і               Set Century On
і               ***
і               Set Mark To "/"
і               *------------------------------------------------------------------------------
і               wkdate =Strtran(Dtoc(Datetime()),[/],[])
і               *21.04.2006 10:33 -> Восстановим старый формат даты
і               Set Date (lcOldDate)
і               ***
і               Set Century &lcOldCentury
і               ***
і               Set Mark To lcOldMark
і               *------------------------------------------------------------------------------
і               
і               *------------------------------------------------------------------------------
і               
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.T.)
і               *------------------------------------------------------------------------------
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і               
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spAccessCount ?lnCardId,	?wkdate, 0,24],[RptItog])
і       АДДДДДДДEnddo
і               
і               
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               Create Table Tmp\RptItog Free (CardID I, CardCode C(1), CardNo C(1), CardOwID I,;
і       і                       CardNote C(1), CardIsAct L, BdCntToday I, BdCnt I)
і       і               *spHandleODBCError()
і       і               *RETURN .F.
і       ГДДДДДДДElse
і       і               Select RptItog
і       і               Copy To Tmp\RptItog.Dbf
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               ***
і               Use In Select([RptItog])
і               
і               *26.01.2005 19:10 -> Вернем список файлов созданных для отчета
і               Return [RptItog.dbf]  &&;RptItog.cdx]
і               *------------------------------------------------------------------------------
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spGetCfMsu()
        * Called by.......: <NA>
        * Parameters......: <tnOldMsuID, tnCurMsuID>
        * Returns.........: <поправочный коэффициент для цены>
        * Notes...........: Перевод из одной ЕИ в другую
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetCfMsu
і               Lparameters tnOldMsuID, tnCurMsuID
і               
і               *09.06.2006 15:50 -> Объявление и инициализация переменных
і               Local	lnCfBaseMsu, ;
і                       lnCfTargMsu, ;
і                       lnResultCf, ;
і                       lnSqlExeResult, ;
і                       llResult
і               ***
і               lnCfBaseMsu = 000000000.00000
і               lnCfTargMsu = 000000000.00000
і               lnResultCf  = 000000000.00000
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Определяем коэффициент для текущей ЕИ
і               lnSqlExeResult = 0
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [SELECT ] + ;
і       і                       [MeasureUnit.MsuQnt ] + ;
і       і                       [FROM MeasureUnit ] + ;
і       і                       [WHERE MeasureUnit.MsuID = ?tnOldMsuID], ;
і       і                       [curOldMsuID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return 0
і       АДДДДДДДEndif
і               ***
і               lnCfBaseMsu = curOldMsuID.MsuQnt
і               ***
і               Use In Select([curOldMsuID])
і               *------------------------------------------------------------------------------
і               
і               *09.06.2006 16:02 -> Определяем коэффициент для целевой ЕИ
і               lnSqlExeResult = 0
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [SELECT ] + ;
і       і                       [MeasureUnit.MsuQnt ] + ;
і       і                       [FROM MeasureUnit ] + ;
і       і                       [WHERE MeasureUnit.MsuID = ?tnCurMsuID], ;
і       і                       [curMsuID])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return 0
і       АДДДДДДДEndif
і               ***
і               lnCfTargMsu = curMsuID.MsuQnt
і               ***
і               Use In Select([curMsuID])
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *09.06.2006 15:55 -> Определяем коэффициент пересчета целевой ЕИ в базовую
і               lnResultCf = lnCfTargMsu / Iif(lnCfBaseMsu = 0, 1, lnCfBaseMsu)
і               *------------------------------------------------------------------------------
і               
і               *09.06.2006 15:55 -> Возвращаем результат
і               Return lnResultCf
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spGetLastIncrementedID()
        * Called by.......: <After Adding Record With Increment Key>
        * Parameters......: <lcEditDBObjName>
        * Returns.........: <lnLastIncrementedID>
        * Notes...........: Возвращает последний идентификатор записи для LV/RV/Table
        *					сгенерированный SPINCREMENTID()
        *-------------------------------------------------------
ЪДДДДДДДProcedure spGetLastIncrementedID
і               Lparameters lcEditDBObjName
і               
і               *01.04.2004 13:51 ->Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnEditDBObjectType, ;
і                       lcSourceTable, ;
і                       lnSqlExeResult, ;
і                       lnLastIncrementedID
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *01.04.2004 13:53 ->Узнаем тип объекта использованного для добавления
і               lnEditDBObjectType = CursorGetProp([SourceType],lcEditDBObjName)
і               *------------------------------------------------------------------------------
і               
і               *01.04.2004 13:56 ->Определим последний сгенерированный идентификатор
і       ЪДДДДДДДDo Case
і       ГДДДДДДДCase lnEditDBObjectType	= 1	&& Local SQL View
і       і               lcSourceTable = CursorGetProp([Tables],lcEditDBObjName)
і       і       ЪДДДДДДДIf ([,]$lcSourceTable)
і       і       і               lcSourceTable = Left(lcSourceTable,At([,],lcSourceTable)-1)
і       і       АДДДДДДДEndif
і       і       ЪДДДДДДДIf ([!]$lcSourceTable)
і       і       і               lcSourceTable = Substr(lcSourceTable,At([!],lcSourceTable)+1)
і       і       АДДДДДДДEndif
і       і               ***
і       і       ЪДДДДДДДIf !Used([LastIncrID])
і       і       і       ЪДДДДДДДIf File([LastIncrID.dbf])
і       і       і       і               Use LastIncrID In 0
і       і       і       ГДДДДДДДElse
і       і       і       і               Return 0
і       і       і       АДДДДДДДEndif
і       і       АДДДДДДДEndif
і       і               ***
і       і               Select LastIncrID
і       і               Locate All For Upper(Alltrim(LastIncrID.TableNM))==Upper(Alltrim(lcSourceTable))
і       і               ***
і       і       ЪДДДДДДДIf Found()
і       і       і               lnLastIncrementedID = LastIncrID.LastId
і       і       ГДДДДДДДElse
і       і       і               lnLastIncrementedID = 0
і       і       АДДДДДДДEndif
і       і               ***
і       і               Use In LastIncrID
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase lnEditDBObjectType = 2 && Remote SQL View
і       і               lcSourceTable = CursorGetProp([Tables],lcEditDBObjName)
і       і       ЪДДДДДДДIf ([,]$lcSourceTable)
і       і       і               lcSourceTable = Left(lcSourceTable,At([,],lcSourceTable)-1)
і       і       АДДДДДДДEndif
і       і       ЪДДДДДДДIf ([!]$lcSourceTable)
і       і       і               lcSourceTable = Substr(lcSourceTable,At([!],lcSourceTable)+1)
і       і       АДДДДДДДEndif
і       і               ***
і       і               lnConnHandler = CursorGetProp([ConnectHandle],lcEditDBObjName)
і       і               lnSqlExeResult = 0
і       і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і       і               lnSqlExeResult = SQLExec(lnConnHandler, ;
і       і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і       і                       [EXECUTE spGetLastIncrementedID ?lcSourceTable],[tmp])
і       і       АДДДДДДДEnddo
і       і               ***
і       і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і       і               spHandleODBCError()
і       і       і               Return 0
і       і       АДДДДДДДEndif
і       і               lnLastIncrementedID = Tmp.LastId
і       і               Use In Tmp
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase lnEditDBObjectType	= 3	&& Table
і       і               lcSourceTable = lcEditDBObjName
і       і       ЪДДДДДДДIf ([!]$lcSourceTable)
і       і       і               lcSourceTable = Substr(lcSourceTable,At([!],lcSourceTable)+1)
і       і       АДДДДДДДEndif
і       і               ***
і       і       ЪДДДДДДДIf !Used([LastIncrID])
і       і       і       ЪДДДДДДДIf File([LastIncrID.dbf])
і       і       і       і               Use LastIncrID In 0
і       і       і       ГДДДДДДДElse
і       і       і       і               Return 0
і       і       і       АДДДДДДДEndif
і       і       АДДДДДДДEndif
і       і               ***
і       і               Select LastIncrID
і       і               Locate All For Upper(Alltrim(LastIncrID.TableNM))==Upper(Alltrim(lcSourceTable))
і       і               ***
і       і       ЪДДДДДДДIf Found()
і       і       і               lnLastIncrementedID = LastIncrID.LastId
і       і       ГДДДДДДДElse
і       і       і               lnLastIncrementedID = 0
і       і       АДДДДДДДEndif
і       і               ***
і       і               Use In LastIncrID
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndcase
і               
і               *01.04.2004 14:37 ->Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *01.04.2004 14:37 ->Вернем значение
і               Return lnLastIncrementedID
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spGetOpenDay()
        * Called by.......: <NA>
        * Parameters......: <tnCashID,tlForce>
        * Returns.........: <none>
        * Notes...........: Проверка открытия локального дня
        * LastEditDate....: 14 November 2006
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetOpenDay
і               Parameters tnCashID,tlForce
і               
і               *29.04.2006 16:16 ->Объявление и инициализация переменных
і               Local   lnRecCount, ;
і                       ltStampOpenDay, ;
і                       lnSLID, ;
і                       ltPOSActCloseStamp, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Проверим количество открытых системных дней
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [SELECT ] + ;
і       і                       [SalesLog.SalesLogID, ] + ;
і       і                       [SalesLog.StampOpenDay ] + ;
і       і                       [FROM SalesLog ] + ;
і       і                       [WHERE SalesLog.EOD = 0], ;
і       і                       [curSalesLog])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               ***
і               lnRecCount = Reccount([curSalesLog])
і               ltStampOpenDay = curSalesLog.StampOpenDay
і               lnSLID = curSalesLog.SalesLogID
і               *------------------------------------------------------------------------------
і               
і               *29.04.2006 15:14 ->Закроем курсор
і               Use In Select([curSalesLog])
і               *------------------------------------------------------------------------------
і               
і       ЪДДДДДДДDo Case
і       ГДДДДДДДCase lnRecCount>1
і       і               Return -2 && осталось открытыми более одного дня
і       ГДДДДДДДCase lnRecCount=0
і       і               Return 0  && нет открытых дней
і       ГДДДДДДДCase lnRecCount=1
і       і               
і       і       ЪДДДДДДДIf !tlForce And (Datetime()-ltStampOpenDay)/3600 > 24
і       і       і               Return lnSLID*-1 && прошло более 24 часов с момента начала общей смены
і       і       АДДДДДДДEndif
і       і               
і       і               *07.04.2006 16:45 -> Проверим, есть ли открытая локальная смена
і       і               lnSqlExeResult = 0
і       і               ***
і       і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і       і                       [SELECT ] + ;
і       і       і                       [POSActivity.POSActID, ] + ;
і       і       і                       [POSActivity.POSActCloseStamp ] + ;
і       і       і                       [FROM POSActivity ] + ;
і       і       і                       [INNER JOIN SalesLog ON SalesLog.SalesLogID = POSActivity.POSActSLID AND POSActivity.POSActCID = ?tnCashID ] + ;
і       і       і                       [WHERE SalesLog.SalesLogID = ?lnSLID], ;
і       і       і                       [curLocalDay])
і       і       АДДДДДДДEnddo
і       і               ***
і       і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і       і               spHandleODBCError()
і       і       і               Return .F.
і       і       АДДДДДДДEndif
і       і               ***
і       і               lnRecCount = Reccount([curLocalDay])
і       і               ltPOSActCloseStamp = curLocalDay.POSActCloseStamp
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *29.04.2006 15:14 ->Закроем курсоры
і       і               Use In Select([curLocalDay])
і       і               *------------------------------------------------------------------------------
і       і               
і       і       ЪДДДДДДДDo Case
і       і       ГДДДДДДДCase lnRecCount=1 And !Isnull(ltPOSActCloseStamp)
і       і       і               Return -1 && локальный день уже закрыт
і       і       ГДДДДДДДCase lnRecCount=0
і       і       і               Return 0
і       і       АДДДДДДДEndcase
і       і               
і       ГДДДДДДДOtherwise
і       і               Return -5 && неизвестная ошибка
і       АДДДДДДДEndcase
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               Return lnSLID
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spGetPayDocExport()
        * Called by.......: <NA>
        * Parameters......: <tnFrmID>
        * Returns.........: <lcUniqueNM>
        * Notes...........: Выборка документов для экспорта в клиент-банк
        *-------------------------------------------------------
ЪДДДДДДДProcedure spGetPayDocExport
і               Lparameters	tnFrmID
і               
і               *16.01.2007 15:29 -> Объявление и инициализация переменных
і               Local	lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       lcUniqueName, ;
і                       lcUniqueFilePath
і               ***
і               lcUniqueName = [_d] + Sys(2015)
і               lcUniqueFilePath = [tmp\] + lcUniqueName + [.DBF]
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:41 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.F.)
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:41 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spGetPayDocExport ?tnFrmID],[PaymentPurpose])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *09.01.2007 17:42 -> Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               Return .F.
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *26.01.2007 10:48 -> Получаем оставшиеся выборки
і               SQLMoreResults(lnConnectHandle,[VatSumText])
і               SQLMoreResults(lnConnectHandle,lcUniqueName)
і               SQLMoreResults(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:42 -> Сохраним курсор в файл и закроем
і               Select (lcUniqueName)
і               Copy To (lcUniqueFilePath)
і               Use In Select(lcUniqueName)
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:43 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 14:27 ->Вернем значение
і               Return lcUniqueName
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spGetPayDocExportAll()
        * Called by.......: <NA>
        * Parameters......: <tnFrmID>
        * Returns.........: <lcUniqueNM>
        * Notes...........: Выборка документов для экспорта в клиент-банк
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetPayDocExportAll
і               Lparameters	tcFrmIDTableNM
і               
і               *16.01.2007 15:29 -> Объявление и инициализация переменных
і               Local	lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       lcUniqueName, ;
і                       lcUniqueFilePath
і               ***
і               lcUniqueName = [_d] + Sys(2015)
і               lcUniqueFilePath = [tmp\] + lcUniqueName + [.DBF]
і               *------------------------------------------------------------------------------
і               
і               *19.06.2007 14:33 -> Откроем таблицу со списком ID выбранных документов
і               Use ([Tmp\] + tcFrmIDTableNM + [.dbf]) In 0 Alias (tcFrmIDTableNM)
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:41 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *19.06.2007 13:06 -> Создаём временную таблицу для хранения идентификаторов и заполняем данными из фокса
і               lnSqlExeResult = 0
і               ***
і               lnSqlExeResult = SQLExec(lnConnectHandle, [CREATE TABLE #] + tcFrmIDTableNM + [ (ID int)])
і               ***
і               Select (tcFrmIDTableNM)
і               ***
і       ЪДДДДДДДScan All
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, [INSERT INTO #] + tcFrmIDTableNM + [ (ID) VALUES (] + Alltrim(Str(Evaluate(tcFrmIDTableNM + [.ID]))) + [)])
і       АДДДДДДДEndscan
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *09.01.2007 17:42 -> Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               Return .F.
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:41 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spGetPayDocExportAll ?tcFrmIDTableNM],lcUniqueName)
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *09.01.2007 17:42 -> Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               Return .F.
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:42 -> Сохраним курсор в файл и закроем
і               Select (lcUniqueName)
і               Copy To (lcUniqueFilePath)
і               Use In Select(lcUniqueName)
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:43 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *19.06.2007 14:32 -> Удаляем таблицу со списком ID выбранных документов
і               Use In Select(tcFrmIDTableNM)
і               Erase ([Tmp\] + tcFrmIDTableNM + [.dbf])
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 14:27 ->Вернем значение
і               Return lcUniqueName
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spGetPayListDoc()
        * Called by.......: <NA>
        * Parameters......: <tnParFrmID>
        * Returns.........: <lcUniqueNM>
        * Notes...........: Формирование списка документов для включения в суммовые документы
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetPayListDoc()
і               Lparameters	tnFrmID
і               
і               *23.09.2004 19:40 -> Объявление и инициализация переменных
і               Local	lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       lcUniqueName, ;
і                       lcUniqueFilePath
і               ***
і               lcUniqueName = [_d] + Sys(2015)
і               lcUniqueFilePath = [tmp\] + lcUniqueName + [.DBF]
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:41 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:41 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spGetPayListDoc ?tnFrmID],lcUniqueName)
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *09.01.2007 17:42 -> Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.01.2007 13:07 -> Создадим пустой курсор
і       і               Create Cursor (lcUniqueName) ( ;
і       і                       ID I, NM C(1) ;
і       і                       )
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:42 -> Сохраним курсор в файл и закроем
і               Select (lcUniqueName)
і               Copy To (lcUniqueFilePath)
і               Use In Select(lcUniqueName)
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:43 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *21.04.2004 14:27 ->Вернем значение
і               Return lcUniqueName
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spGetPaymentPurpose()
        * Called by.......: <NA>
        * Parameters......: <tnFrmID>
        * Returns.........: <lcUniqueNM>
        * Notes...........: Формирование строки назначение платежа для расчетных документов
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetPaymentPurpose
і               Lparameters	tnFrmID
і               
і               *25.01.2007 11:57 -> Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       lcPaymentPurpose
і               ***
і               lcOldAlias = Alias()
і               lcPaymentPurpose = []
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:41 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:41 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spGetPaymentPurpose ?tnFrmID, ?lcPaymentPurpose],[PaymentPurpose])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *09.01.2007 17:42 -> Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               Return .F.
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *25.01.2007 12:07 -> Сохраним курсор в файл и закроем
і       ЪДДДДДДДIf Reccount([PaymentPurpose]) > 0
і       і               lcPaymentPurpose = PaymentPurpose.PaymentPurpose
і       АДДДДДДДEndif
і               Use In Select([PaymentPurpose])
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:43 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *01.04.2004 14:37 ->Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *25.01.2007 12:07 -> Вернем значение
і               Return lcPaymentPurpose
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spGetResourceUsage()
        * Called by.......: <NA>
        * Parameters......: <tnMsuID, tdStartDate, tuValue>
        * Returns.........: <Datetime / Numeric>
        * Notes...........: Вычисление времени использования ресурса (конечная дата или количество ресурса)
        * Last Editor.....: Владимир Боярских
        * Last Edit.......: September 13, 2007
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetResourceUsage
і               Lparameters tnMsuID, tdStartDate, tuValue
і               
і               *13.09.2007 13:51 -> Объявление и инициализация переменных
і               Local   lnConnectHandle, ;
і                       lnSqlExeResult
і               *------------------------------------------------------------------------------
і               
і               *13.09.2007 13:51 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.09.2007 14:00 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [SELECT ] + ;
і       і                       [MsuTransKoeff = dbo.MsuTransKoeff(MeasureUnit.BaseMsuID, MeasureUnit.MsuID, NULL) ] + ;
і       і                       [FROM MeasureUnit ] + ;
і       і                       [WHERE MeasureUnit.MsuID = ?tnMsuID],[curMsu])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *13.09.2007 14:11 -> Получим конечную дату использования ресурса
і       ЪДДДДДДДIf Type([tuValue]) == [N]
і       і               && Количество ресурса домножаем на коэффициент ед.изм. времени,
і       і               && домножаем на 60 секунд и прибавляем к начальной дате
і       і               Return tdStartDate + (tuValue * curMsu.MsuTransKoeff * 60)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і       ЪДДДДДДДIf Type([tuValue]) == [D]
і       і               tuValue = Dtot(tuValue)
і       і               
і       АДДДДДДДEndif
і               *13.09.2007 14:18 -> Получим количество использованного ресурса
і       ЪДДДДДДДIf Type([tuValue]) == [T]
і       і               && Из конечной даты вычитаем начальную и делим полученное количество
і       і               && на 60 секунд и на коэффициент ед.изм. времени
і       і       ЪДДДДДДДIf (curMsu.MsuTransKoeff * 60) # 0
і       і       і               Return (tuValue - tdStartDate) / (curMsu.MsuTransKoeff * 60)
і       і       АДДДДДДДEndif
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *13.09.2007 14:12 -> Что-то сработало не так
і               Return .F.
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spGetSaleSum()
        * Called by.......: <NA>
        * Parameters......: <tcQryParSID>
        * Returns.........: <none>
        * Notes...........: Расчитываем сумму продаж за период
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetSaleSum
і               Lparameters tcQryParSID
і               
і               *28.02.2006 12:16 ->Объявление и инициализация переменных
і               Local	lcOldDate, ;
і                       lcOldCentury, ;
і                       lcOldMark, ;
і                       lcOldAlias, ;
і                       lcFilterExpr, ;
і                       luQryParDateEnabled, ;
і                       luQryParDateStartDate, ;
і                       luQryParDateEndDate, ;
і                       luQryParCashEnabled, ;
і                       luQryParCashTableNM, ;
і                       luQryParCashierEnabled, ;
і                       luQryParCashierTableNM, ;
і                       luQryParTvrEnabled, ;
і                       luQryParTvrIDTableNM, ;
і                       lnSalesSum
і               ***
і               lcOldDate = Set([DATE])
і               lcOldCentury = Set([CENTURY])
і               lcOldMark = Set([MARK])
і               lcOldAlias	 = Alias()
і               lcFilterExpr = []
і               *------------------------------------------------------------------------------
і               
і               *06.03.2006 16:22 ->Дальнейшие параметры обрабатываем, если существует менеджер параметров
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *06.03.2006 16:22 ->Формируем фильтр по дате
і       і               luQryParDateEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplDateEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParDateEnabled) And Type([luQryParDateEnabled])==[L] And luQryParDateEnabled
і       і       і               
і       і       і               *06.03.2006 16:22 ->Получим дату стартовую и конечную
і       і       і               luQryParDateStartDate = oQryParMgr.ParamGet(tcQryParSID,[qpdDateStart])
і       і       і               luQryParDateEndDate = oQryParMgr.ParamGet(tcQryParSID,[qpdDateEnd])
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *21.04.2006 10:33 -> Установим формат даты YMD и CENTURY ON
і       і       і               Set Date YMD
і       і       і               ***
і       і       і               Set Century On
і       і       і               ***
і       і       і               Set Mark To "/"
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *06.03.2006 16:22 ->Формируем условие
і       і       і       ЪДДДДДДДDo Case
і       і       і       ГДДДДДДДCase	!Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate) And ;
і       і       і       і                       !Isnull(luQryParDateEndDate) And Type([luQryParDateEndDate])==[D] And !Empty(luQryParDateEndDate)
і       і       і       і               *{
і       і       і       і               lcFilterExpr = lcFilterExpr + [ AND CheckSale.CheckStamp >= ']+Strtran(Dtoc(luQryParDateStartDate),[/],[])+[' AND CheckSale.CheckStamp < ']+Strtran(Dtoc(luQryParDateEndDate+1),[/],[])+[']
і       і       і       і               *}
і       і       і       ГДДДДДДДCase	!Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate)
і       і       і       і               *{
і       і       і       і               lcFilterExpr = lcFilterExpr + [ AND CheckSale.CheckStamp >= ']+Strtran(Dtoc(luQryParDateStartDate),[/],[])+[']
і       і       і       і               *}
і       і       і       ГДДДДДДДCase	!Isnull(luQryParDateEndDate) And Type([luQryParDateEndDate])==[D] And !Empty(luQryParDateEndDate)
і       і       і       і               *{
і       і       і       і               lcFilterExpr = lcFilterExpr + [ AND CheckSale.CheckStamp < ']+Strtran(Dtoc(luQryParDateEndDate+1),[/],[])+[']
і       і       і       і               *}
і       і       і       АДДДДДДДEndcase
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *21.04.2006 10:33 -> Восстановим старый формат даты
і       і       і               Set Date (lcOldDate)
і       і       і               ***
і       і       і               Set Century &lcOldCentury
і       і       і               ***
і       і       і               Set Mark To lcOldMark
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *02.06.2006 11:34 ->Формируем фильтр по кассе
і       і               luQryParCashEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCashEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParCashEnabled) And Type([luQryParCashEnabled])==[L] And luQryParCashEnabled
і       і       і               luQryParCashTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCashTableNM])
і       і       і       ЪДДДДДДДIf !Isnull(luQryParCashTableNM) And Type([luQryParCashTableNM])==[C] And File(luQryParCashTableNM+[.dbf])
і       і       і       і               
і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і               lcFilterExpr = lcFilterExpr+[ AND CheckSale.CheckCashID IN (]+spGetTmpValueList(luQryParCashTableNM)+[)]
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *02.06.2006 11:34 ->Формируем фильтр по кассиру
і       і               luQryParCashierEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCashierEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParCashierEnabled) And Type([luQryParCashierEnabled])==[L] And luQryParCashierEnabled
і       і       і               luQryParCashierTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCashierTableNM])
і       і       і       ЪДДДДДДДIf !Isnull(luQryParCashierTableNM) And Type([luQryParCashierTableNM])==[C] And File(luQryParCashierTableNM+[.dbf])
і       і       і       і               
і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і               lcFilterExpr = lcFilterExpr+[ AND CheckSale.CheckCashierID IN (]+spGetTmpValueList(luQryParCashierTableNM)+[)]
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *02.06.2006 11:38 ->Формируем фильтр (Выбор товаров)
і       і               luQryParTvrEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplTvrEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParTvrEnabled) And Type([luQryParTvrEnabled])==[L] And luQryParTvrEnabled
і       і       і               
і       і       і               *23.04.2006 00:32 ->Получим имя временной таблицы с идентификаторами товАРОВ
і       і       і               luQryParTvrIDTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcTvrIDTableNM])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParTvrIDTableNM) And Type([luQryParTvrIDTableNM])==[C] And File([tmp\]+luQryParTvrIDTableNM+[.dbf])
і       і       і       і               
і       і       і       і               *10.04.2006 11:35 -> Сформируем фильтр
і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і                       [ AND CheckTrans.CheckTransTvrId IN (]+spGetTmpValueList(luQryParTvrIDTableNM)+[)]
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spGetSaleSum ?lcFilterExpr],[curSaleSum])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return 0
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *06.03.2006 16:24 ->Сохраним сумму
і               lnSalesSum = curSaleSum.SaleSum
і               *------------------------------------------------------------------------------
і               
і               *06.03.2006 16:23 ->Закроем курсор
і               Use In Select([curSaleSum])
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *06.03.2006 16:30 ->Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.07.2006 16:51 -> Вернем результат
і               Return lnSalesSum
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spGetTmpValueList()
        * Called by.......: <N/A>
        * Parameters......: <tcIDTableNM>
        * Returns.........: <lcValueList>
        * Notes...........: Получение списка значений идентификаторов из временной таблицы
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetTmpValueList
і               Lparameters tcIDTableNM
і               
і               *10.04.2006 11:42 -> Объявление и инициализация переменных
і               Local	luValue, ;
і                       lcValueList
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 11:30 -> Откроем временную таблицу
і       ЪДДДДДДДIf !Used(tcIDTableNM)
і       і               Use (tcIDTableNM) In 0
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 11:34 -> Сформируем список значений идентификаторов
і               Select (tcIDTableNM)
і               lcValueList = []
і               ***
і       ЪДДДДДДДScan All
і       і               luValue = Evaluate(tcIDTableNM + [.ID])
і       і       ЪДДДДДДДIf Type([luValue]) == [N] And !Isnull(luValue)
і       і       і               lcValueList = lcValueList + Alltrim(Str(luValue)) + [,]
і       і       АДДДДДДДEndif
і       АДДДДДДДEndscan
і               ***
і               lcValueList = Left(lcValueList,Len(lcValueList)-1)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 11:35 -> Закроем временную таблицу
і               Use In Select(tcIDTableNM)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 11:45 -> Вернем результат
і               Return lcValueList
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spGetTvrLbl()
        * Called by.......: <NA>
        * Parameters......: <none>
        * Returns.........: <none>
        * Notes...........: Формирование временной таблицы для печати ценников и этикеток
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetTvrLbl
і               Lparameters tcExecVar,tuParam1
і               
і               *08.08.2005 12:10 -> Объявление и инициализация переменных
і               Local	lcFilterExpr, ;
і                       lcAliasListToClose, ;
і                       luQryParTLUTypeEnabled, ;
і                       luQryParTLUTypeIDTableNM, ;
і                       luQryParPrcTypeEnabled, ;
і                       luQryParPrcTypeID, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               
і               Local Array aTvrLbl(1)
і               ***
і               lcFilterExpr = [WHERE 1=0]
і               lcAliasListToClose = []
і               *------------------------------------------------------------------------------
і               
і       ЪДДДДДДДDo Case
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[NODATA]
і       і               
і       і               *21.04.2004 12:34 ->Формируем фильтр, для формирования пустой выборки
і       і               lcFilterExpr = [WHERE 1=0 ]
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[BYTVRID]
і       і               
і       і               *21.04.2004 12:32 ->Формируем фильтр для выбора одного документа
і       і               lcFilterExpr = [WHERE Tovar.TvrID = ]+Alltrim(Str(tuParam1))
і       і               *------------------------------------------------------------------------------
і       і               
і       ГДДДДДДДCase Type([tcExecVar])==[C] And tcExecVar==[BYFILTER]
і       і               
і       і               *24.08.2005 16:45 -> Установим фильтр
і       і               lcFilterExpr = [WHERE 1=1]
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *08.08.2005 12:19 ->Формируем фильтр по типам идентификаторов
і       і               luQryParTLUTypeEnabled = oQryParMgr.ParamGet(tuParam1,[qplTLUTypeEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParTLUTypeEnabled) And Type([luQryParTLUTypeEnabled])==[L] And luQryParTLUTypeEnabled
і       і       і               
і       і       і               *08.08.2005 12:20 -> Получим имя временной таблицы с типами идентификаторов
і       і       і               luQryParTLUTypeIDTableNM = oQryParMgr.ParamGet(tuParam1,[qpcTLUTypeIDTableNM])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParTLUTypeIDTableNM) And Type([luQryParTLUTypeIDTableNM])==[C] And File([tmp\]+luQryParTLUTypeIDTableNM+[.dbf])
і       і       і       і               
і       і       і       і               *26.03.2007 15:57 ->Сформируем фильтр
і       і       і       і               lcFilterExpr = lcFilterExpr + ;
і       і       і       і                       [ AND TvrLookUp.TLUTypeID IN (]+spGetTmpValueList(luQryParTLUTypeIDTableNM)+[)]
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *27.04.2006 12:19 ->Формируем фильтр по типам прайс-листов
і       і               luQryParPrcTypeEnabled = oQryParMgr.ParamGet(tuParam1,[qplPrcTypeEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParPrcTypeEnabled) And Type([luQryParPrcTypeEnabled])==[L] And luQryParPrcTypeEnabled
і       і       і               
і       і       і               *27.04.2006 12:20 -> Получим идентификатор прайс-листа
і       і       і               luQryParPrcTypeID = oQryParMgr.ParamGet(tuParam1,[qpnPrcTypeID])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParPrcTypeID) And Type([luQryParPrcTypeID])==[N]
і       і       і       і               lcFilterExpr = lcFilterExpr + [ AND Price.PrcTypeID = ]+Alltrim(Str(luQryParPrcTypeID))
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndcase
і               *------------------------------------------------------------------------------
і               
і               *26.03.2007 17:11 ->Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 ->Привязываем
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [SELECT ] + ;
і       і                       [Tovar.TvrID, ] + ;
і       і                       [Tovar.TvrNM, ] + ;
і       і                       [ISNULL(TvrLookUp.TLUID,000000) AS TLUID, ] + ;
і       і                       [ISNULL(TvrLookUp.TLU,SPACE(13)) AS TLU, ] + ;
і       і                       [0 AS Qnt, ] + ;
і       і                       [ISNULL(Price.Price,0) AS Price ] + ;
і       і                       [FROM Tovar ] + ;
і       і                       [INNER JOIN Price ON Price.TvrID = Tovar.TvrID ] + ;
і       і                       [LEFT JOIN TvrLookUp ON TvrLookUp.TvrID = Tovar.TvrID ] + ;
і       і                       lcFilterExpr, [curTvrLbl])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               
і               *26.03.2007 16:09->Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *09.08.2005 12:26 -> Сохраняем во временную таблицу результат
і               Select * From curTvrLbl Into Table Tmp\TvrLbl.Dbf
і               *------------------------------------------------------------------------------
і               
і               *09.08.2005 12:26 -> Закроем курсор
і               Use In Iif(Used([curTvrLbl]),[curTvrLbl],0)
і               *------------------------------------------------------------------------------
і               
і               *09.08.2005 12:26 -> Закроем временную таблицу
і               Use In Iif(Used([TvrLbl]),[TvrLbl],0)
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spGetVatSumText()
        * Called by.......: <NA>
        * Parameters......: <tnFrmID, tlBlankIfZero>
        * Returns.........: <lcVatSumText>
        * Notes...........: Формирование строки с суммой налога для расчетных документов
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spGetVatSumText
і               Lparameters	tnFrmID, tlBlankIfZero
і               
і               *25.01.2007 12:10 -> Объявление и инициализация переменных
і               Local	lcOldAlias, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       lcVatSumText
і               ***
і               lcOldAlias = Alias()
і               lcVatSumText = []
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:41 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:41 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spGetVatSumText ?tnFrmID, ?tlBlankIfZero, ?lcVatSumText],[VatSumText])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               
і       і               *09.01.2007 17:42 -> Вызовем обработчик ошибок
і       і               spHandleODBCError()
і       і               Return .F.
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *25.01.2007 12:07 -> Сохраняем строку
і       ЪДДДДДДДIf Reccount([VatSumText]) > 0
і       і               lcVatSumText = VatSumText.VatSumText
і       АДДДДДДДEndif
і               Use In Select([VatSumText])
і               *------------------------------------------------------------------------------
і               
і               *09.01.2007 17:43 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *01.04.2004 14:37 ->Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *25.01.2007 12:07 -> Вернем значение
і               Return lcVatSumText
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spHandleODBCError()
        * Called by.......: <NA>
        * Parameters......: <taErrors>
        * Returns.........: <none>
        * Notes...........: Обработка ошибок ODBC
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spHandleODBCError
і               
і               *28.07.2006 09:38 ->Объявление и инициализация переменных
і               Local	lnErrorRowsCount, ;
і                       lnCounter, ;
і                       lcErrorMessage,lcStErrorMessage,;
і                       lcWSNM   ,;
і                       ltDateTime,;
і                       lcUserNM
і               ***
і               Local Array laErrors[1],laStErrors[1]
і               ***
і               lcErrorMessage = []
і               *------------------------------------------------------------------------------
і               lcWSNM   = Sys(0)
і               lcUserNM = Alltrim(Substr(lcWSNM,At([#],lcWSNM)+1))
і               lcWSNM   = Alltrim(Left(lcWSNM,At([#],lcWSNM)-1))
і               ltDateTime = Datetime()
і               
і               *21.01.2004 18:52 -> Прочитаем информацию об ошибке
і               lnErrorRowsCount = Aerror(laErrors)
і               lnStErrorRowsCount = Astackinfo(laStErrors)
і               *------------------------------------------------------------------------------
і               
і               *28.07.2006 09:37 -> Последовательно обработаем все ошибки
і       ЪДДДДДДДIf !File('ErrorStack.dbf')
і       і               Create Table ErrorStack Free (StLevel Int Null, PrgFl Varchar(254) Null, ObjModul Varchar(254) Null,;
і       і                       ObjModFl Varchar(254) Null,LineNum Int Null, SourCont Varchar(254) Null,;
і       і                       UserNm Varchar(254) Null,Stamp_ Datetime Null,WSNM  Varchar(254) Null)
і       ГДДДДДДДElse
і       і               Use In Select('ErrorStack')
і       і               Use ErrorStack In 0
і       АДДДДДДДEndif
і               Insert Into ErrorStack  From Array laStErrors
і               Replace All UserNm With lcUserNM ,;
і                       WSNM   With lcWSNM   ,;
і                       Stamp_ With ltDateTime In ErrorStack  For Empty(WSNM)
і               
і       ЪДДДДДДДIf !File('ErrorLog.dbf')
і       і               Create Table ErrorLog Free(ErrNum1 Int Null, ErrorMs2 Varchar(254) Null, ErorrPar3 Varchar(254) Null,;
і       і                       WkArr4 Varchar(254) Null,TrgType5 Varchar(254) Null, ODBCConn6 Varchar(254) Null,;
і       і                       OleEx Int Null, ;
і       і                       UserNm Varchar(254) Null,Stamp_ Datetime Null,WSNM  Varchar(254) Null)
і       ГДДДДДДДElse
і       і               Use In Select('ErrorLog')
і       і               Use ErrorLog In 0
і       АДДДДДДДEndif
і               Insert Into ErrorLog From Array laErrors
і               Replace All UserNm With lcUserNM ,;
і                       WSNM   With lcWSNM   ,;
і                       Stamp_ With ltDateTime In ErrorLog For Empty(WSNM)
і               
і       ЪДДДДДДДFor lnCounter = 1 To lnErrorRowsCount
і       і       ЪДДДДДДДIf laErrors[lnCounter,5] # 50001
і       і       і               lcErrorMessage = lcErrorMessage + Strtran(laErrors[lnCounter,3],pcvERRORHEADMSG,[* ]) + Chr(13)
і       і       АДДДДДДДEndif
і       і               Strtofile(Ttoc(Datetime())+[ -> ] + Strtran(laErrors[lnCounter,3],pcvERRORHEADMSG,[]) + Chr(13),[Error.log],1)
і       і               
і       і               *** Надо сохранить: сообщение об ошибке
і       і               ***  состояние стека
і       АДДДДДДДEndfor
і               *------------------------------------------------------------------------------
і               Use In Select('ErrorStack')
і               Use In Select('ErrorLog')
і               *28.07.2006 09:46 -> Выводим сообщение пользователю
і       ЪДДДДДДДIf lnErrorRowsCount > 0
і       і               *MESSAGEBOX(lcErrorMessage,16,[Ошибка соединения...])
і       і               Messagebox('Возможны неверные данные ввода. Проверте данные и повторите операцию.',48,'Предупреждение')
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored Procedures for Basis
        * Module/Procedure: spInventoryBludo()
        * Called by.......: <NA>
        * Parameters......: <tnFrmID>
        * Returns.........: <Кол-во подблюд (блюд содержащихся в блюдах)>
        * Notes...........: Разворачивает блюда по ингридиентам
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spInventoryBludo
і               Lparameters tnFrmID
і               
і               *19.06.2006 12:23 ->Объявление и инициализация переменных
і               Local   lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       lnRecCnt
і               *------------------------------------------------------------------------------
і               
і               *06.12.2006 12:12 ->Покажем сообщение для пользователя
і               Wait Window [Ждите. Идет обработка данных...] Nowait Noclear
і               Set Message To [Ждите. Идет обработка данных...]
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spInventoryBludo ?tnFrmID],[curTmp])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return
і       АДДДДДДДEndif
і               ***
і               lnRecCnt = curTmp.RecCnt
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *06.12.2006 12:13 ->Уберем сообщение
і               Wait Clear
і               Set Message To []
і               *------------------------------------------------------------------------------
і               
і               *20.06.2006 12:39 -> Вывод сообщения пользователю
і               Messagebox([Обработка документа успешно завершена. Развернуто блюд: ] + Alltrim(Str(lnRecCnt)) + [.],64,[Информация])
і               *------------------------------------------------------------------------------
і               
і               *19.06.2006 12:30 -> Вернем результат
і               Return .T.
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: Basis.pjx
        * File............: Stored procedures for Basis
        * Module/Procedure: spInventoryReport()
        * Called by.......: <NA>
        * Parameters......: <tcQryParSID>
        * Returns.........: <Список временных файлов, созданных для отчета>
        * Notes...........: Выборка для отчета "Сличительная ведомость"
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spInventoryReport
і               Lparameters tcQryParSID
і               
і               *12.05.2006 11:02 -> Объявление и инициализация переменных
і               Local	lnFrmID, ;
і                       lcOldAlias, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult
і               ***
і               lcOldAlias = Alias()
і               *------------------------------------------------------------------------------
і               
і               *12.05.2006 11:02 -> Создаем таблицу с окружением для отчёта
і               Create Table Tmp\RptEnv Free (QryParSID C(10))
і               Insert Into RptEnv (QryParSID) Values (tcQryParSID)
і               *------------------------------------------------------------------------------
і               
і               *12.05.2006 11:02 ->Читаем параметры
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *12.05.2006 11:02 -> Читаем идентификатор документа, который будем печатать
і       і               lnFrmID = oQryParMgr.ParamGet(tcQryParSID,[FrmID])
і       і               *------------------------------------------------------------------------------
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.F.)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:45 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і                       [EXECUTE spInventoryReport ?lnFrmID],[RptItogHD])
і       АДДДДДДДEnddo
і               ***
і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і               spHandleODBCError()
і       і               Return .F.
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:03 -> Получаем вторую результирующую выборку
і               SQLMoreResults(lnConnectHandle,[RptItogDT])
і               SQLMoreResults(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *07.04.2006 16:12 -> Делаем дисконнект: освобождаем соединение
і               SQLDisconnect(lnConnectHandle)
і               *------------------------------------------------------------------------------
і               
і               *10.04.2006 14:07 -> Сохраним курсоры на диск и закроем
і               Select RptItogHD
і               Copy To Tmp\RptItogHD.Dbf
і               ***
і               Select RptItogDT
і               Copy To Tmp\RptItogDT.Dbf
і               ***
і               Use In Select([RptItogHD])
і               Use In Select([RptItogDT])
і               *------------------------------------------------------------------------------
і               
і               *12.05.2006 11:29 -> Восстановим текущий Alias
і       ЪДДДДДДДIf !Empty(lcOldAlias) And Used(lcOldAlias) And lcOldAlias#Alias()
і       і               Select(lcOldAlias)
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *12.05.2006 11:29 -> Вернем список временных таблиц для построения отчета
і               Return [RptItogHD.dbf;RptItogDT.dbf;RptEnv.dbf]
і               *------------------------------------------------------------------------------
і               
АДДДДДДДEndproc
        *******************************************************************************
        ******************************** END PROCEDURE ********************************
        *******************************************************************************
        *-------------------------------------------------------
        * Project.........: BASIS.PJX
        * File............: STORED PROCEDURES FOR BASIS
        * Module/Procedure: spJurnal
        * Called by.......: <NA>
        * Parameters......: <tcQryParSID>
        * Returns.........: <none>
        * Notes...........: Формирование выборки для журнала-ордера
        * LastEditDate....: 28 June 2007
        * LastEditor......: Volga
        *------------------------------------------------------------------------------
ЪДДДДДДДProcedure spJurnal
і               Lparameters tcQryParSID
і               
і               *11.05.2007 12:13 -> Объявление и инициализация переменных
і               Local	lcOldDate, ;
і                       lcOldCentury, ;
і                       lcOldMark, ;
і                       lcOldAlias, ;
і                       lcFilterExpr, ;
і                       luQryParDateEnabled, ;
і                       luQryParDateStartDate, ;
і                       luQryParDateEndDate, ;
і                       luQryParAccBuchEnabled, ;
і                       luQryParAccBuchID, ;
і                       luQryParAccBuchTableNM, ;
і                       luQryCorrAccBuchID, ;
і                       luQryParOUEnabled, ;
і                       luQryParOUID, ;
і                       luQryParOUTableNM, ;
і                       luQryParCLEnabled, ;
і                       luQryParCLID, ;
і                       luQryParCLTableNM, ;
і                       lnConnectHandle, ;
і                       lnSqlExeResult, ;
і                       luQryParOUSQLNM , ;
і                       luQryParClSqlNM
і               ***
і               Store Null To luQryParOUSQLNM , ;
і                       luQryParClSqlNM , ;
і                       luQryCorrAccBuchID
і               ***
і               lcOldDate = Set([DATE])
і               lcOldCentury = Set([CENTURY])
і               lcOldMark = Set([MARK])
і               lcOldAlias = Alias()
і               lcFilterExpr = [WHERE 0<>1]
і               lcBalanceFilterExpr = [WHERE 0<>1]
і               *------------------------------------------------------------------------------
і               *07.04.2006 16:13 -> Коннектимся к БД через существующее соединение
і               lnConnectHandle = SQLCONNECTBAS(pcvCONNECTIONNAME)
і               
і               *21.07.2005 12:13 ->Дальнейшие параметры обрабатываем, если существует менеджер параметров
і       ЪДДДДДДДIf Type([oQryParMgr])==[O] And !Isnull(oQryParMgr)
і       і               
і       і               *21.07.2005 15:37 ->Создаем таблицу с окружением для отчёта
і       і               Create Table Tmp\RptEnv Free (QryParSID C(10), QryTypeNM C(40))
і       і               Insert Into RptEnv (QryParSID) Values (tcQryParSID)
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *19.01.2007 15:06 -> Сформируем условия выбора по дате
і       і               luQryParDateEnabled   = oQryParMgr.ParamGet(tcQryParSID,[qplDateEnabled])
і       і               luQryParDateStartDate = oQryParMgr.ParamGet(tcQryParSID,[qpdDateStart])
і       і               luQryParDateEndDate   = oQryParMgr.ParamGet(tcQryParSID,[qpdDateEnd])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParDateEnabled)   And Type([luQryParDateEnabled])==[L]   And luQryParDateEnabled And ;
і       і       і                       !Isnull(luQryParDateStartDate) And Type([luQryParDateStartDate])==[D] And !Empty(luQryParDateStartDate) And ;
і       і       і                       !Isnull(luQryParDateEndDate)   And Type([luQryParDateEndDate])==[D]   And !Empty(luQryParDateEndDate)
і       і       і               
і       і       і               *19.01.2007 15:06 -> Установим формат даты YMD и CENTURY ON
і       і       і               Set Date YMD
і       і       і               Set Century On
і       і       і               Set Mark To "/"
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *19.01.2007 15:06 -> Сформируем условия выбора
і       і       і               lcFilterExpr = lcFilterExpr + [ AND JurnalOrder.FrmDateAcc >= ']+Strtran(Dtoc(luQryParDateStartDate),[/],[])+[' AND JurnalOrder.FrmDateAcc < ']+Strtran(Dtoc(luQryParDateEndDate+1),[/],[])+[']
і       і       і               lcBalanceFilterExpr = lcBalanceFilterExpr + [ AND JurnalOrder.FrmDateAcc < ']+Strtran(Dtoc(luQryParDateStartDate),[/],[])+[']
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       і               *19.01.2007 15:06 -> Восстановим старый формат даты
і       і       і               Set Date (lcOldDate)
і       і       і               Set Century &lcOldCentury
і       і       і               Set Mark To lcOldMark
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       ГДДДДДДДElse
і       і       і               
і       і       і               *19.01.2007 15:05 -> Выведем сообщение о необходимости указать стартовую и конечную дату для построения отчёта
і       і       і               Messagebox([Для построения данного отчёта необходимо указать стартовую и конечную дату отчётного периода],48,[Предупреждение])
і       і       і               Return .F.
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *23.04.2008 14:08 -> Формируем фильтр (Бухгалтерский счет)
і       і               luQryParAccBuchEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplAccBuchEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParAccBuchEnabled) And Type([luQryParAccBuchEnabled])==[L] And luQryParAccBuchEnabled
і       і       і               
і       і       і               *23.01.2007 14:08 -> Получим идентификатор бухгалтерского счета
і       і       і               luQryParAccBuchID = oQryParMgr.ParamGet(tcQryParSID,[qpnAccBuchID])
і       і       і               *------------------------------------------------------------------------------
і       і       і               *23.01.2007 14:08 -> Получим идентификатор бухгалтерского счета
і       і       і               luQryParAccBuchTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcAccBuchTableNM])
і       і       і               *------------------------------------------------------------------------------
і       і       і       ЪДДДДДДДIf !Isnull(luQryParAccBuchTableNM) And Type([luQryParAccBuchTableNM])==[C] And File([tmp\]+luQryParAccBuchTableNM+[.dbf])
і       і       і       і               
і       і       і       і               *11.05.2007 11:35 -> Сформируем фильтр
і       і       і       і               luQryParBuchSQLNM = '#QryParBuchSQLNM'
і       і       і       і               lnSqlExeResult = 0
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і       і       і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і       і       і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і       і       і       і                       [CREATE TABLE ]+ luQryParBuchSQLNM + [(ID int) ])
і       і       і       і       і               Use (luQryParAccBuchTableNM) In 0 Alias Buchid
і       і       і       і       і               Select Buchid
і       і       і       і       і       ЪДДДДДДДScan All
і       і       і       і       і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і       і       і       і       і                       [ INSERT INTO ] + luQryParBuchSQLNM + [ (ID)  VALUES ( ?Buchid.id )] )
і       і       і       і       і       АДДДДДДДEndscan
і       і       і       і       і               Use In Buchid
і       і       і       і       АДДДДДДДEnddo
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і       і       і       і               spHandleODBCError()
і       і       і       і       і               Return .F.
і       і       і       і       АДДДДДДДEndif
і       і       і       АДДДДДДДEndif
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               *23.04.2008 14:08 -> Формируем фильтр (Корреспондентский Бухгалтерский счет)
і       і               luQryParCorBuchEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCorrAccEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParCorBuchEnabled) And Type([luQryParCorBuchEnabled])==[L] And luQryParCorBuchEnabled
і       і       і               
і       і       і               *23.01.2007 14:08 -> Получим идентификатор бухгалтерского счета
і       і       і               luQryCorrAccBuchID = oQryParMgr.ParamGet(tcQryParSID,[qpnCorrAccBuchID])
і       і       і               *------------------------------------------------------------------------------
і       і       АДДДДДДДEndif
і       і               *------------------------------------------------------------------------------
і       і               
і       і               *11.05.2007 14:08 -> Формируем фильтр (Список отделов)
і       і               
і       і               *11.05.2007 11:26 ->Формируем фильтр по подразделению
і       і               luQryParOUEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplOUEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParOUEnabled) And Type([luQryParOUEnabled])==[L] And luQryParOUEnabled
і       і       і               
і       і       і               *11.05.2007 11:26 ->Получим имя таблицы с идентификаторами подразделений
і       і       і               luQryParOUTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcOUIDTableNM])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParOUTableNM) And Type([luQryParOUTableNM])==[C] And File([tmp\]+luQryParOUTableNM+[.dbf])
і       і       і       і               
і       і       і       і               *11.05.2007 11:35 -> Сформируем фильтр
і       і       і       і               luQryParOUSQLNM = '#QryParOUSQLNM'
і       і       і       і               lnSqlExeResult = 0
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і       і       і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і       і       і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і       і       і       і                       [CREATE TABLE ]+ luQryParOUSQLNM + [(ID int) ])
і       і       і       і       і               Use (luQryParOUTableNM) In 0 Alias Ouid
і       і       і       і       і               Select Ouid
і       і       і       і       і       ЪДДДДДДДScan All
і       і       і       і       і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і       і       і       і       і                       [ INSERT INTO ] + luQryParOUSQLNM + [ (ID)  VALUES ( ?ouid.id )] )
і       і       і       і       і       АДДДДДДДEndscan
і       і       і       і       і               Use In Ouid
і       і       і       і       АДДДДДДДEnddo
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і       і       і       і               spHandleODBCError()
і       і       і       і       і               Return .F.
і       і       і       і       АДДДДДДДEndif
і       і       і       АДДДДДДДEndif
і       і       АДДДДДДДEndif
і       і               *11.05.2007 11:26 ->Формируем фильтр по клиентам
і       і               luQryParCLEnabled = oQryParMgr.ParamGet(tcQryParSID,[qplCltEnabled])
і       і               ***
і       і       ЪДДДДДДДIf !Isnull(luQryParCLEnabled) And Type([luQryParCLEnabled])==[L] And luQryParCLEnabled
і       і       і               
і       і       і               *11.05.2007 11:26 ->Получим имя таблицы с идентификаторами клиентов
і       і       і               luQryParCLTableNM = oQryParMgr.ParamGet(tcQryParSID,[qpcCltIDTableNM])
і       і       і               ***
і       і       і       ЪДДДДДДДIf !Isnull(luQryParCLTableNM) And Type([luQryParClTableNM])==[C] And File([tmp\]+luQryParCLTableNM+[.dbf])
і       і       і       і               
і       і       і       і               *11.05.2007 11:35 -> Сформируем фильтр
і       і       і       і               luQryParClSqlNM = '#QryParCLSQLNM'
і       і       і       і               lnSqlExeResult = 0
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і       і       і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і       і       і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
і       і       і       і       і                       [CREATE TABLE ]+ luQryParClSqlNM + [(ID int) ])
і       і       і       і       і               Use (luQryParCLTableNM) In 0 Alias Ouid
і       і       і       і       і               Select Ouid
і       і       і       і       і       ЪДДДДДДДScan All
і       і       і       і       і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і       і       і       і       і                       [ INSERT INTO ] + luQryParClSqlNM + [ (ID)  VALUES ( ?ouid.id )] )
і       і       і       і       і       АДДДДДДДEndscan
і       і       і       і       і               Use In Ouid
і       і       і       і       АДДДДДДДEnddo
і       і       і       і               ***
і       і       і       і       ЪДДДДДДДIf lnSqlExeResult = -1
і       і       і       і       і               spHandleODBCError()
і       і       і       і       і               Return .F.
і       і       і       і       АДДДДДДДEndif
і       і       і       і               
і       і       і       і               *------------------------------------------------------------------------------
і       і       і       і               
і       і       і       АДДДДДДДEndif
і       і       і               *------------------------------------------------------------------------------
і       і       і               
і       і       АДДДДДДДEndif
і       і               
і       АДДДДДДДEndif
і               *------------------------------------------------------------------------------
і               
і               *------------------------------------------------------------------------------
і               
і               *13.04.2006 14:01 -> Установим свойство BatchMode в False, чтобы получать результирующие выборки с сервера по очереди командой SQLMoreResults
і               SQLSetprop(lnConnectHandle,[BatchMode],.F.)
і               *------------------------------------------------------------------------------
і               
і               *19.01.2007 13:12 -> Выполняем запрос
і               lnSqlExeResult = 0
і               ***
і       ЪДДДДДДДDo While (lnSqlExeResult = 0) And (lnSqlExeResult # -1)
і       і               lnSqlExeResult = SQLExec(lnConnectHandle, ;
і       і                       [SET LOCK_TIMEOUT ] + pcvLOCKTIMEOUT + [ ] + ;
